<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>æ•°å­—å†…é˜ - ç»„å»ºä½ çš„æ•°å­—å†…é˜</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'PingFang SC', 'Microsoft YaHei', sans-serif;
      background: linear-gradient(135deg, #1a1a3e 0%, #0f0f23 100%);
      min-height: 100vh;
      color: #e2e8f0;
      line-height: 1.6;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    html {
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .container {
      max-width: 900px;
      margin: 40px auto;
      padding: 40px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      position: relative;
    }

    .container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background:
        radial-gradient(circle at 50% 50%, rgba(102, 126, 234, 0.1) 0%, transparent 60%),
        radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.1) 0%, transparent 50%);
      pointer-events: none;
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
      position: relative;
      z-index: 1;
    }

    .brand-name {
      font-size: 36px;
      font-weight: 800;
      background: linear-gradient(135deg, #667eea 0%, #f093fb 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 8px;
      letter-spacing: 2px;
    }

    .page-title {
      font-size: 28px;
      font-weight: 700;
      color: #fff;
      margin-bottom: 16px;
    }

    .page-subtitle {
      font-size: 16px;
      color: #94a3b8;
      max-width: 600px;
      margin: 0 auto;
    }

    .input-section {
      margin-bottom: 40px;
      position: relative;
      z-index: 1;
    }

    .input-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    label {
      display: block;
      font-weight: 600;
      color: #fff;
      font-size: 16px;
    }

    .input-hint {
      font-size: 14px;
      color: #64748b;
    }

    textarea {
      width: 100%;
      padding: 20px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      resize: vertical;
      min-height: 200px;
      font-size: 16px;
      font-family: inherit;
      color: #e2e8f0;
      transition: all 0.3s ease;
    }

    textarea:focus {
      outline: none;
      border-color: rgba(102, 126, 234, 0.5);
      box-shadow: 0 0 20px rgba(102, 126, 234, 0.2);
    }

    textarea::placeholder {
      color: #64748b;
    }

    .button-group {
      display: flex;
      gap: 16px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    button {
      flex: 1;
      min-width: 200px;
      padding: 16px 32px;
      border-radius: 30px;
      font-size: 16px;
      font-weight: 600;
      text-decoration: none;
      transition: all 0.3s;
      cursor: pointer;
      border: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(102, 126, 234, 0.5);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: #e2e8f0;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.15);
      border-color: rgba(255, 255, 255, 0.3);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
      box-shadow: none !important;
    }

    .progress-section {
      margin: 40px 0;
      padding: 30px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      position: relative;
      z-index: 1;
    }

    .progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .progress-header h3 {
      font-size: 18px;
      font-weight: 700;
      color: #fff;
    }

    .progress-status {
      font-size: 14px;
      color: #64748b;
    }

    .progress-bar {
      width: 100%;
      height: 12px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 6px;
      overflow: hidden;
      margin: 20px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      border-radius: 6px;
      transition: width 0.5s ease;
      position: relative;
    }

    .progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .status-text {
      font-size: 16px;
      color: #94a3b8;
      text-align: center;
      margin-top: 16px;
    }

    .result-section {
      margin-top: 40px;
      padding-top: 30px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      position: relative;
      z-index: 1;
    }

    .result-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .result-header h3 {
      font-size: 20px;
      font-weight: 700;
      color: #fff;
      margin-bottom: 8px;
    }

    .result-header p {
      font-size: 14px;
      color: #64748b;
    }

    .result-card {
      margin: 20px 0;
      padding: 24px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .result-card:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(102, 126, 234, 0.3);
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    }

    .result-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #667eea, #764ba2);
    }

    .result-card h4 {
      font-size: 18px;
      font-weight: 700;
      color: #fff;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .result-card h4::before {
      content: '';
      width: 4px;
      height: 16px;
      background: linear-gradient(180deg, #667eea, #764ba2);
      border-radius: 2px;
    }

    .result-content {
      font-size: 16px;
      line-height: 1.7;
      white-space: pre-wrap;
      word-break: break-word;
      color: #e2e8f0;
    }

    .error-message {
      color: #f87171;
      margin-top: 16px;
      padding: 16px;
      background: rgba(248, 113, 113, 0.1);
      border-radius: 8px;
      border: 1px solid rgba(248, 113, 113, 0.2);
      position: relative;
      z-index: 1;
    }

    .success-message {
      color: #34d399;
      margin-top: 16px;
      padding: 16px;
      background: rgba(52, 211, 153, 0.1);
      border-radius: 8px;
      border: 1px solid rgba(52, 211, 153, 0.2);
      position: relative;
      z-index: 1;
    }

    .back-link {
      display: inline-block;
      margin-top: 30px;
      color: #667eea;
      text-decoration: none;
      font-weight: 600;
      transition: all 0.3s ease;
      font-size: 14px;
    }

    .back-link:hover {
      color: #764ba2;
      text-decoration: underline;
    }

    /* Workflow Steps Styles */
    .workflow-step {
      margin-bottom: 16px;
      padding: 20px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
    }

    .workflow-step:hover {
      background: rgba(255, 255, 255, 0.05);
      transform: translateX(4px);
    }

    .workflow-step.active {
      border-color: rgba(102, 126, 234, 0.5);
      background: rgba(102, 126, 234, 0.1);
    }

    .workflow-step.completed {
      border-color: rgba(76, 175, 80, 0.5);
      background: rgba(76, 175, 80, 0.05);
    }

    .workflow-step.failed {
      border-color: rgba(244, 67, 54, 0.5);
      background: rgba(244, 67, 54, 0.05);
    }

    .step-header {
      display: flex;
      align-items: center;
      gap: 16px;
      cursor: pointer;
    }

    .step-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 20px;
      color: #fff;
      flex-shrink: 0;
    }

    .step-icon.planning {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .step-icon.execution {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .step-icon.review {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .step-icon.archive {
      background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }

    .step-info {
      flex: 1;
    }

    .step-info h4 {
      font-size: 16px;
      font-weight: 600;
      color: #fff;
      margin-bottom: 4px;
    }

    .step-desc {
      font-size: 13px;
      color: #94a3b8;
    }

    .step-status {
      font-size: 13px;
      font-weight: 500;
      padding: 6px 12px;
      border-radius: 20px;
      background: rgba(255, 255, 255, 0.1);
      color: #94a3b8;
      white-space: nowrap;
    }

    .workflow-step.active .step-status {
      background: rgba(102, 126, 234, 0.3);
      color: #667eea;
      animation: pulse 2s infinite;
    }

    .workflow-step.completed .step-status {
      background: rgba(76, 175, 80, 0.3);
      color: #4caf50;
    }

    .workflow-step.failed .step-status {
      background: rgba(244, 67, 54, 0.3);
      color: #f44336;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .step-content {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      display: none;
    }

    .workflow-step.active .step-content {
      display: block;
    }

    .thinking-box, .output-box {
      margin-bottom: 16px;
      border-radius: 8px;
      overflow: hidden;
    }

    .thinking-header, .output-header {
      padding: 12px 16px;
      font-weight: 600;
      font-size: 14px;
    }

    .thinking-header {
      background: rgba(255, 193, 7, 0.2);
      color: #ffc107;
    }

    .output-header {
      background: rgba(76, 175, 80, 0.2);
      color: #4caf50;
    }

    .thinking-content, .output-content {
      padding: 16px;
      background: rgba(0, 0, 0, 0.2);
      font-size: 14px;
      line-height: 1.7;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .result-content {
      -webkit-overflow-scrolling: touch;
    }

    /* Responsive Styles */
    @media (max-width: 768px) {
      .container {
        margin: 20px;
        padding: 30px;
        border-radius: 12px;
      }

      .brand-name {
        font-size: 28px;
      }

      .page-title {
        font-size: 24px;
      }

      .button-group {
        flex-direction: column;
      }

      button {
        width: 100%;
        min-width: unset;
      }

      textarea {
        min-height: 150px;
        padding: 16px;
      }

      .progress-section {
        padding: 20px;
      }

      .result-card {
        padding: 20px;
      }
    }

    /* Small Mobile */
    @media (max-width: 480px) {
      .container {
        margin: 10px;
        padding: 20px;
      }

      .brand-name {
        font-size: 24px;
      }

      .page-title {
        font-size: 20px;
      }

      .page-subtitle {
        font-size: 14px;
      }

      textarea {
        min-height: 120px;
        font-size: 14px;
      }

      button {
        padding: 14px 24px;
        font-size: 15px;
      }

      .progress-section {
        padding: 16px;
      }

      .result-card {
        padding: 16px;
      }

      .result-card h4 {
        font-size: 16px;
      }

      /* è§’è‰²å¡ç‰‡æ¨ªå‘æ»šåŠ¨ */
      .roles-grid {
        display: flex !important;
        overflow-x: auto !important;
        scroll-snap-type: x mandatory;
        -webkit-overflow-scrolling: touch;
        gap: 16px !important;
        padding: 8px 0;
      }

      .role-card {
        min-width: 280px !important;
        flex-shrink: 0;
        scroll-snap-align: start;
      }

      .role-img {
        width: 60px !important;
        height: 60px !important;
      }
    }

      .result-content {
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
  <nav class="top-nav">
    <div class="nav-container">
      <a href="/" class="nav-logo">diyici.ai</a>
      <div class="nav-links">
        <a href="/knowledge.html" class="nav-link">å¼€åˆ›è€…çŸ¥è¯†åº“</a>
        <a href="/" class="nav-link">å…³äºæˆ‘ä»¬</a>
        <a href="/cabinet.html" class="nav-link nav-link-primary">å¼€å§‹ä½¿ç”¨</a>
      </div>
    </div>
  </nav>

  <style>
    .top-nav {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      background: rgba(15, 15, 35, 0.95);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(102, 126, 234, 0.2);
      padding: 0 20px;
    }
    .nav-container {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      height: 60px;
    }
    .nav-logo {
      font-size: 20px;
      font-weight: 700;
      background: linear-gradient(135deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-decoration: none;
    }
    .nav-links {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .nav-link {
            white-space: nowrap;
      color: #94a3b8;
      text-decoration: none;
      font-size: 14px;
      padding: 8px 16px;
      border-radius: 8px;
      transition: all 0.3s;
    }
    .nav-link:hover {
      color: #fff;
      background: rgba(102, 126, 234, 0.2);
    }
    .nav-link-active {
      color: #667eea;
      background: rgba(102, 126, 234, 0.1);
    }
    @media (max-width: 768px) {
      .nav-container { height: 56px; }
      .nav-logo { font-size: 16px; }
      .nav-link {
            white-space: nowrap; font-size: 12px; padding: 6px 8px; }
    }
  </style>

  <div class="container" style="padding-top: 80px;">
    <div class="header">
      <div class="brand-name">æ•°å­—å†…é˜</div>
      <h1 class="page-title">æŠŠæ¨¡ç³Šçš„æƒ³æ³•ï¼Œå˜æˆæ¸…æ¥šçš„æ­¥éª¤</h1>
      <p class="page-subtitle">åƒçœŸæ­£çš„å›¢é˜Ÿä¸€æ ·å¸®ä½ æ€è€ƒï¼šè°‹å±€ã€æ‰§è¡Œã€å®¡æŸ¥ã€æ•´ç†</p>
      <a href="/knowledge.html" style="display: inline-block; margin-top: 12px; padding: 8px 16px; background: rgba(245,158,11,0.2); border: 1px solid rgba(245,158,11,0.3); border-radius: 20px; color: #f59e0b; font-size: 12px; text-decoration: none; transition: all 0.3s;">ğŸ“š æµè§ˆå¼€åˆ›è€…çŸ¥è¯†åº“ â†’</a>
    </div>

    <!-- æ•°å­—å†…é˜ä»‹ç» -->
    <div class="cabinet-intro" style="margin-bottom: 40px; position: relative; z-index: 1;">
      <h2 style="font-size: 20px; font-weight: 700; color: #fff; margin-bottom: 24px; text-align: center;">æ•°å­—å†…é˜å·¥ä½œæµç¨‹</h2>
      <p style="text-align: center; color: #94a3b8; margin-bottom: 32px;">é¦–è¾…ï¼ˆè°‹å±€ï¼‰ã€å¹²åï¼ˆæ‰§è¡Œï¼‰ã€å¾¡å²ï¼ˆå®¡æŸ¥ï¼‰ã€å²å®˜ï¼ˆæ²‰æ·€ï¼‰ï¼Œä¸€èµ·å¸®ä½ å®Œæˆä»è§„åˆ’åˆ°æ‰§è¡Œçš„å…¨æµç¨‹</p>

      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; margin-bottom: 24px;" class="roles-grid">
        <!-- è°‹å±€è€… -->
        <div style="padding: 24px; background: rgba(255, 255, 255, 0.05); border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1); text-align: center; transition: all 0.3s ease;" class="role-card">
          <div style="margin-bottom: 16px;">
            <img src="https://trae-api-cn.mchost.guru/api/ide/v1/text_to_image?prompt=smart%20business%20consultant%20analyzing%20data%20charts%2C%20wearing%20formal%20attire%2C%20modern%20flat%20design%2C%20dark%20purple%20background%2C%20professional%20corporate%20style&image_size=square" alt="è°‹å±€è€…" style="width: 80px; height: 80px; object-fit: contain;" class="role-img">
          </div>
          <h3 style="font-size: 16px; font-weight: 700; color: #fff; margin-bottom: 12px;">é¦–è¾…ï¼ˆè°‹å±€ï¼‰</h3>
          <p style="font-size: 12px; color: #94a3b8; line-height: 1.5;">åˆ†æç”¨æˆ·éœ€æ±‚ï¼Œåˆ¶å®šè¯¦ç»†çš„è¡ŒåŠ¨æŒ‡å—ï¼Œæ˜ç¡®ä»»åŠ¡ç›®æ ‡ã€æ­¥éª¤å’Œé¢„æœŸæˆæœã€‚</p>
        </div>

        <!-- æ‰§è¡Œè€… -->
        <div style="padding: 24px; background: rgba(255, 255, 255, 0.05); border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1); text-align: center; transition: all 0.3s ease;" class="role-card">
          <div style="margin-bottom: 16px;">
            <img src="https://trae-api-cn.mchost.guru/api/ide/v1/text_to_image?prompt=efficient%20project%20manager%20executing%20tasks%2C%20holding%20checklist%2C%20dynamic%20action%20pose%2C%20modern%20flat%20design%2C%20dark%20purple%20background%2C%20professional%20style&image_size=square" alt="æ‰§è¡Œè€…" style="width: 80px; height: 80px; object-fit: contain;" class="role-img">
          </div>
          <h3 style="font-size: 16px; font-weight: 700; color: #fff; margin-bottom: 12px;">å¹²åï¼ˆæ‰§è¡Œï¼‰</h3>
          <p style="font-size: 12px; color: #94a3b8; line-height: 1.5;">æ ¹æ®è¡ŒåŠ¨æŒ‡å—æ‰§è¡Œä»»åŠ¡ï¼Œç”Ÿæˆé«˜è´¨é‡çš„åˆç‰ˆæˆæœï¼Œç¡®ä¿æˆæœç¬¦åˆç”¨æˆ·éœ€æ±‚ã€‚</p>
        </div>

        <!-- æ‰¾èŒ¬è€… -->
        <div style="padding: 24px; background: rgba(255, 255, 255, 0.05); border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1); text-align: center; transition: all 0.3s ease;" class="role-card">
          <div style="margin-bottom: 16px;">
            <img src="https://trae-api-cn.mchost.guru/api/ide/v1/text_to_image?prompt=strict%20quality%20inspector%20with%20magnifying%20glass%2C%20reviewing%20documents%2C%20critical%20analysis%2C%20modern%20flat%20design%2C%20dark%20purple%20background%2C%20professional%20style&image_size=square" alt="æ‰¾èŒ¬è€…" style="width: 80px; height: 80px; object-fit: contain;" class="role-img">
          </div>
          <h3 style="font-size: 16px; font-weight: 700; color: #fff; margin-bottom: 12px;">å¾¡å²ï¼ˆå®¡æŸ¥ï¼‰</h3>
          <p style="font-size: 12px; color: #94a3b8; line-height: 1.5;">ä¸¥æ ¼å®¡æ ¸æäº¤çš„æˆæœï¼Œæ‰¾å‡ºé—®é¢˜å’Œä¸è¶³ï¼Œç»™å‡ºè¯¦ç»†çš„å®¡æ ¸æŠ¥å‘Šï¼Œæœ€ç»ˆåšå‡ºè£å†³ï¼šé€šè¿‡æˆ–ä¸é€šè¿‡ã€‚</p>
        </div>
      </div>

      <!-- æ²‰æ·€è€…å•ç‹¬ä¸€è¡Œ -->
      <div style="display: grid; grid-template-columns: 1fr; gap: 24px; margin-bottom: 32px;" class="finalizer-grid">
        <!-- æ²‰æ·€è€… -->
        <div style="padding: 24px; background: rgba(255, 255, 255, 0.05); border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1); text-align: center; transition: all 0.3s ease; max-width: 400px; margin: 0 auto;" class="role-card">
          <div style="margin-bottom: 16px;">
            <img src="https://trae-api-cn.mchost.guru/api/ide/v1/text_to_image?prompt=knowledge%20archivist%20organizing%20documents%2C%20creating%20reports%2C%20summarizing%20information%2C%20modern%20flat%20design%2C%20dark%20purple%20background%2C%20professional%20style&image_size=square" alt="æ²‰æ·€è€…" style="width: 80px; height: 80px; object-fit: contain;" class="role-img">
          </div>
          <h3 style="font-size: 16px; font-weight: 700; color: #fff; margin-bottom: 12px;">å²å®˜ï¼ˆæ²‰æ·€ï¼‰</h3>
          <p style="font-size: 12px; color: #94a3b8; line-height: 1.5;">æ€»ç»“æ•´ä¸ªæµç¨‹ï¼Œæå–å…³é”®ä¿¡æ¯ï¼Œç”Ÿæˆå¯å¤ç”¨çš„ä¸‡èƒ½æ¨¡æ¿ï¼Œç¡®ä¿æ¨¡æ¿ç»“æ„æ¸…æ™°ã€å†…å®¹å®Œæ•´ã€‚</p>
        </div>
      </div>

      <!-- å·¥ä½œæµç¨‹ -->
      <div style="padding: 24px; background: rgba(255, 255, 255, 0.05); border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1); margin-bottom: 32px;">
        <h3 style="font-size: 16px; font-weight: 700; color: #fff; margin-bottom: 16px; text-align: center;">å·¥ä½œæµç¨‹</h3>
        <div style="display: flex; flex-direction: column; gap: 12px;">
          <div style="display: flex; align-items: center; gap: 12px;">
            <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px;">1</div>
            <p style="color: #e2e8f0; flex: 1;"><span style="font-weight: 600; color: #fff;">æäº¤éœ€æ±‚</span> - è¾“å…¥æ‚¨çš„å…·ä½“éœ€æ±‚ï¼Œè¶Šè¯¦ç»†è¶Šå¥½</p>
          </div>
          <div style="display: flex; align-items: center; gap: 12px;">
            <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px;">2</div>
            <p style="color: #e2e8f0; flex: 1;"><span style="font-weight: 600; color: #fff;">é¦–è¾…ï¼ˆè°‹å±€ï¼‰åˆ†æ</span> - åˆ¶å®šè¯¦ç»†çš„è¡ŒåŠ¨æŒ‡å—</p>
          </div>
          <div style="display: flex; align-items: center; gap: 12px;">
            <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px;">3</div>
            <p style="color: #e2e8f0; flex: 1;"><span style="font-weight: 600; color: #fff;">å¹²åï¼ˆæ‰§è¡Œï¼‰æ‰§è¡Œ</span> - æ ¹æ®æŒ‡å—ç”Ÿæˆåˆç‰ˆæˆæœ</p>
          </div>
          <div style="display: flex; align-items: center; gap: 12px;">
            <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px;">4</div>
            <p style="color: #e2e8f0; flex: 1;"><span style="font-weight: 600; color: #fff;">å¾¡å²ï¼ˆå®¡æŸ¥ï¼‰å®¡æ ¸</span> - ä¸¥æ ¼å®¡æ ¸å¹¶æå‡ºæ”¹è¿›æ„è§</p>
          </div>
          <div style="display: flex; align-items: center; gap: 12px;">
            <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px;">5</div>
            <p style="color: #e2e8f0; flex: 1;"><span style="font-weight: 600; color: #fff;">å²å®˜ï¼ˆæ²‰æ·€ï¼‰æ€»ç»“</span> - ç”Ÿæˆå¯å¤ç”¨çš„ä¸‡èƒ½æ¨¡æ¿</p>
          </div>
        </div>
      </div>
    </div>

    <!-- æ–°ç”¨æˆ·æç¤º -->
    <div style="background: rgba(102, 126, 234, 0.1); border: 1px solid rgba(102, 126, 234, 0.3); border-radius: 12px; padding: 16px; margin-bottom: 24px;">
      <div style="display: flex; align-items: flex-start; gap: 12px;">
        <span style="font-size: 24px;">â±ï¸</span>
        <div>
          <p style="color: #e2e8f0; font-weight: 600; margin-bottom: 8px;">é¢„è®¡éœ€è¦å‡ åˆ†é’Ÿå®Œæˆ</p>
          <p style="color: #94a3b8; font-size: 12px; line-height: 1.6;">æ•°å­—å†…é˜ä¼šä¾æ¬¡åä½œå®Œæˆåˆ†æã€æ‰§è¡Œã€å®¡æ ¸ã€æ²‰æ·€ã€‚è™½ç„¶æ¯”å•æ¬¡å›å¤æ…¢ä¸€äº›ï¼Œä½†èƒ½å¾—åˆ°æ›´å®Œæ•´ã€å¯æ‰§è¡Œçš„æ–¹æ¡ˆï¼Œè¿˜æœ‰å¯å¤ç”¨çš„æ¨¡æ¿ã€‚</p>
        </div>
      </div>
    </div>

    <div class="input-section">
      <div class="input-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
        <label for="user-input">è¯·æè¿°æ‚¨çš„éœ€æ±‚</label>
        <div style="display: none;">
          <label id="strict-mode-label" style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 12px; color: #94a3b8;">
            <input type="checkbox" id="strict-mode" checked style="accent-color: #667eea;">
            <span>ğŸš€ æ‡’äººæ¨¡å¼</span>
          </label>
          <span class="tooltip" title="æ‡’äººæ¨¡å¼ä¼šå¼ºåˆ¶AIè¾“å‡ºï¼š1.é‡åŒ–ç›®æ ‡ 2.å…·ä½“æ­¥éª¤ 3.æ˜ç¡®èµ„æº 4.é£é™©æ§åˆ¶ 5.ç¦æ­¢ç©ºè¯" style="color: #64748b; cursor: help;">â“˜</span>
        </div>
      </div>
      <!-- æ‡’äººæ¨¡å¼è¯´æ˜ï¼ˆé»˜è®¤éšè—ï¼‰ -->
      <div id="strict-mode-info" style="display: none; background: rgba(102, 126, 234, 0.1); border: 1px solid rgba(102, 126, 234, 0.3); border-radius: 8px; padding: 12px; margin-bottom: 12px; font-size: 12px; color: #e2e8f0;">
        <strong style="color: #fbbf24;">ğŸš€ æ‡’äººæ¨¡å¼å·²å¼€å¯ï¼ŒAIå°†è‡ªåŠ¨ä¸ºä½ ï¼š</strong>
        <ul style="margin: 8px 0 0 16px; color: #94a3b8; line-height: 1.8;">
          <li>é‡åŒ–æ‰€æœ‰ç›®æ ‡ï¼ˆå…·ä½“æ•°å­—ã€ç™¾åˆ†æ¯”ã€æ—¶é—´èŠ‚ç‚¹ï¼‰</li>
          <li>æ˜ç¡®æ¯ä¸ªæ­¥éª¤ã€åšä»€ä¹ˆã€‘+ã€æ€ä¹ˆåšã€‘+ã€éªŒæ”¶æ ‡å‡†ã€‘</li>
          <li>æ¸…æ™°èµ„æºéœ€æ±‚ï¼šäººåŠ›ã€é¢„ç®—ã€å·¥å…·ã€æ—¶é—´</li>
          <li>è¯†åˆ«é£é™©å¹¶æä¾›åº”å¯¹æ–¹æ¡ˆ</li>
          <li>æœç»ç©ºæ³›è¡¨è¿°ï¼Œè¾“å‡ºå¯ç›´æ¥æ‰§è¡Œçš„å†…å®¹</li>
          <li>æä¾›å¯ç›´æ¥ä½¿ç”¨çš„è¯æœ¯/æ¨¡æ¿/è‡ªæŸ¥è¡¨</li>
        </ul>
      </div>
      <span class="input-hint">æ”¯æŒä¸Šä¼ å›¾ç‰‡ã€PDFã€Word ç­‰æ–‡ä»¶ï¼Œæˆ–ç›´æ¥åœ¨ä¸‹æ–¹è¾“å…¥æ–‡æœ¬</span>

      <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
      <div class="file-upload-section" style="margin-bottom: 16px;">
        <label for="file-input" class="file-upload-area" id="file-upload-area" ondragover="event.preventDefault(); this.style.borderColor='#667eea';" ondragleave="event.preventDefault(); this.style.borderColor='rgba(102, 126, 234, 0.5)';" ondrop="event.preventDefault(); this.style.borderColor='rgba(102, 126, 234, 0.5)'; handleFiles(event.dataTransfer.files);" style="border: 2px dashed rgba(102, 126, 234, 0.5); border-radius: 12px; padding: 24px; text-align: center; background: rgba(102, 126, 234, 0.05); cursor: pointer; transition: all 0.3s ease; display: block;">
          <div class="upload-icon" style="font-size: 48px; margin-bottom: 12px;">ğŸ“</div>
          <p style="color: #94a3b8; margin-bottom: 8px;">ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ </p>
          <p style="color: #64748b; font-size: 12px;">æ”¯æŒä»»æ„æ–‡ä»¶æ ¼å¼</p>
          <p style="color: #94a3b8; font-size: 11px; margin-top: 6px;">âš ï¸ å•ä¸ªæ–‡ä»¶æœ€å¤§ 20MB</p>
          <div style="margin-top: 12px; padding: 10px; background: rgba(251, 191, 36, 0.1); border-radius: 8px; border-left: 3px solid #fbbf24;">
            <p style="color: #fbbf24; font-size: 11px; margin: 0;">ğŸ’¡ æç¤ºï¼šä¸ºä¿è¯æœ€ä½³å¤„ç†æ•ˆæœï¼Œå»ºè®®ä¸Šä¼ å†…å®¹ç²¾ç‚¼çš„æ–‡æ¡£ã€‚è¶…é•¿ç¯‡å†…å®¹å¯èƒ½ä¼šè¢«æ™ºèƒ½ç²¾ç®€å¤„ç†ã€‚</p>
          </div>
        </label>
        <input type="file" id="file-input" style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0;" onchange="handleFiles(this.files)" multiple>

        <!-- å·²ä¸Šä¼ æ–‡ä»¶åˆ—è¡¨ -->
        <div id="file-list" style="margin-top: 12px; display: none;">
          <p style="color: #94a3b8; font-size: 12px; margin-bottom: 8px;">å·²ä¸Šä¼ æ–‡ä»¶ï¼š</p>
          <div id="file-items" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
        </div>
      </div>

      <textarea id="user-input" placeholder="è¯·è¯¦ç»†æè¿°æ‚¨çš„éœ€æ±‚ï¼Œæˆ–ä¸Šä¼ æ–‡ä»¶ååœ¨æ­¤è¡¥å……è¯´æ˜..."></textarea>

      <div class="button-group">
        <button id="submit-btn" class="btn-primary">
          <span>å¼€å§‹æ‰§è¡Œ</span>
        </button>
        <button id="reset-btn" class="btn-secondary">
          <span>é‡ç½®</span>
        </button>
      </div>
    </div>

    <div class="progress-section" style="display: none;">
      <div class="progress-header">
        <h3>æ‰§è¡Œè¿›åº¦</h3>
        <span class="progress-status" id="progress-percentage">0%</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" style="width: 0%;"></div>
      </div>
      <div class="status-text" id="status-text">å‡†å¤‡ä¸­...</div>

      <!-- å®æ—¶å·¥ä½œæµç¨‹å±•ç¤º -->
      <div id="workflow-visualization" style="margin-top: 32px;">
        <!-- è°‹å±€è€… -->
        <div class="workflow-step" id="step-planning" data-step="planning">
          <div class="step-header">
            <div class="step-icon planning">è°‹</div>
            <div class="step-info">
              <h4>é¦–è¾…ï¼ˆè°‹å±€ï¼‰æ­£åœ¨åˆ†æ...</h4>
              <p class="step-desc">æ‹†è§£éœ€æ±‚ï¼Œåˆ¶å®šè¡ŒåŠ¨æŒ‡å—</p>
            </div>
            <div class="step-status">â³ è¿›è¡Œä¸­</div>
          </div>
          <div class="step-content" style="display: none;">
            <div class="thinking-box">
              <div class="thinking-header">æ€è€ƒè¿‡ç¨‹</div>
              <div class="thinking-content" id="planning-thinking">æ­£åœ¨åˆ†ææ‚¨çš„éœ€æ±‚...</div>
            </div>
            <div class="output-box">
              <div class="output-header">è¡ŒåŠ¨æŒ‡å—</div>
              <div class="output-content" id="planning-output">ç­‰å¾…ç”Ÿæˆ...</div>
            </div>
          </div>
        </div>

        <!-- æ‰§è¡Œè€… -->
        <div class="workflow-step" id="step-execution" data-step="execution">
          <div class="step-header">
            <div class="step-icon execution">æ‰§</div>
            <div class="step-info">
              <h4>å¹²åï¼ˆæ‰§è¡Œï¼‰æ­£åœ¨å¹²æ´»...</h4>
              <p class="step-desc">æŒ‰ç…§æŒ‡å—äº§å‡ºåˆç‰ˆæˆæœ</p>
            </div>
            <div class="step-status">â¸ï¸ ç­‰å¾…ä¸­</div>
          </div>
          <div class="step-content" style="display: none;">
            <div class="thinking-box">
              <div class="thinking-header">æ‰§è¡Œæ€è·¯</div>
              <div class="thinking-content" id="execution-thinking">ç­‰å¾…å¯åŠ¨...</div>
            </div>
            <div class="output-box">
              <div class="output-header">åˆç‰ˆæˆæœ</div>
              <div class="output-content" id="execution-output">ç­‰å¾…ç”Ÿæˆ...</div>
            </div>
          </div>
        </div>

        <!-- æ‰¾èŒ¬è€… -->
        <div class="workflow-step" id="step-review" data-step="review">
          <div class="step-header">
            <div class="step-icon review">æŸ¥</div>
            <div class="step-info">
              <h4>å¾¡å²ï¼ˆå®¡æŸ¥ï¼‰æ­£åœ¨å®¡æ ¸...</h4>
              <p class="step-desc">ä¸¥æ ¼æ£€æŸ¥ï¼Œå‘ç°é—®é¢˜</p>
            </div>
            <div class="step-status">â¸ï¸ ç­‰å¾…ä¸­</div>
          </div>
          <div class="step-content" style="display: none;">
            <div class="thinking-box">
              <div class="thinking-header">å®¡æ ¸å‘ç°</div>
              <div class="thinking-content" id="review-thinking">ç­‰å¾…å®¡æ ¸...</div>
            </div>
            <div class="output-box">
              <div class="output-header">å®¡æ ¸æŠ¥å‘Š</div>
              <div class="output-content" id="review-output">ç­‰å¾…ç”Ÿæˆ...</div>
            </div>
          </div>
        </div>

        <!-- æ²‰æ·€è€… -->
        <div class="workflow-step" id="step-archive" data-step="archive">
          <div class="step-header">
            <div class="step-icon archive">è®°</div>
            <div class="step-info">
              <h4>å²å®˜ï¼ˆæ²‰æ·€ï¼‰æ­£åœ¨æ€»ç»“...</h4>
              <p class="step-desc">æå–æ¨¡æ¿ï¼Œæ²‰æ·€ç»éªŒ</p>
            </div>
            <div class="step-status">â¸ï¸ ç­‰å¾…ä¸­</div>
          </div>
          <div class="step-content" style="display: none;">
            <div class="thinking-box">
              <div class="thinking-header">ç»éªŒæ€»ç»“</div>
              <div class="thinking-content" id="archive-thinking">ç­‰å¾…æ€»ç»“...</div>
            </div>
            <div class="output-box">
              <div class="output-header">ä¸‡èƒ½æ¨¡æ¿</div>
              <div class="output-content" id="archive-output">ç­‰å¾…ç”Ÿæˆ...</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="result-section" style="display: none;">
      <div class="result-header">
        <h3>æ‰§è¡Œç»“æœ</h3>
        <p>æ•°å­—å†…é˜å·²å®Œæˆæ‚¨çš„éœ€æ±‚ï¼Œä»¥ä¸‹æ˜¯è¯¦ç»†æ‰§è¡Œè¿‡ç¨‹</p>
      </div>
      <div id="result-container"></div>
      <a href="/" class="back-link">â† è¿”å›é¦–é¡µ</a>
    </div>
  </div>


    <!-- å…³äºå¼¹çª— -->
    <div id="info-modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:99999;overflow-y:auto;">
      <div style="max-width:800px;margin:40px auto;background:linear-gradient(180deg,#1a1a3e 0%,#0f0f23 100%);border-radius:20px;padding:40px;position:relative;border:1px solid rgba(102,126,234,0.3);">
        <button onclick="closeInfoModal()" style="position:absolute;top:20px;right:20px;width:40px;height:40px;background:rgba(255,255,255,0.1);border:none;border-radius:50%;color:#94a3b8;font-size:20px;cursor:pointer;">Ã—</button>
        <div style="color:#e2e8f0;line-height:1.8;">
          <h2 style="font-size:28px;font-weight:700;color:#fff;margin-bottom:8px;text-align:center;">å…³äº diyici.ai</h2>
          <p style="font-size:16px;color:#667eea;text-align:center;margin-bottom:32px;">ç¬¬ä¸€æ¬¡ï¼Œç»„å»ºä½ çš„æ•°å­—å†…é˜</p>
          <p style="margin-bottom:16px;color:#94a3b8;">diyici.ai å¸®ä½ æŠŠ"æ¨¡ç³Šçš„æƒ³æ³•"ï¼Œå˜æˆ"å¯ä»¥ç…§ç€åšçš„æ­¥éª¤"ã€‚</p>
          <p style="margin-bottom:24px;color:#94a3b8;">å››ä¸ªè§’è‰²ä¸€èµ·åä½œï¼šé¦–è¾…è°‹å±€ã€å¹²åæ‰§è¡Œã€å¾¡å²å®¡æŸ¥ã€å²å®˜æ²‰æ·€ã€‚</p>
          <div style="text-align:center;padding:24px;background:linear-gradient(135deg,rgba(102,126,234,0.2),rgba(118,75,162,0.2));border-radius:12px;margin-top:32px;">
            <a href="/cabinet.html" style="display:inline-block;padding:14px 32px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:8px;color:#fff;text-decoration:none;font-weight:600;font-size:16px;">å¼€å§‹ä½¿ç”¨</a>
          </div>
        </div>
      </div>
    </div>
    <script>
    function openInfoModal() {
      var modal = document.getElementById('info-modal');
      if (modal) {
        modal.style.display = 'block';
        document.body.style.overflow = 'hidden';
      }
    }
    function closeInfoModal() {
      var modal = document.getElementById('info-modal');
      if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
      }
    }
    document.addEventListener('click', function(e) {
      if (e.target.id === 'info-modal') {
        closeInfoModal();
      }
    });
    </script>
    <script>
    function showInfoModal() {
      console.log("showInfoModal called");
      document.getElementById('info-modal').style.display = 'block';
      document.body.style.overflow = 'hidden';
    }
    function closeInfoModal() {
      document.getElementById('info-modal').style.display = 'none';
      document.body.style.overflow = 'auto';
    }
    document.getElementById('info-modal')?.addEventListener('click', function(e) {
      if (e.target === this) closeInfoModal();
    });
    // æ–‡ä»¶ä¸Šä¼ å¤„ç†
    // ä¸ºåä¸ºæ‰‹æœºç­‰ç§»åŠ¨ç«¯æ·»åŠ å¤‡ç”¨ç‚¹å‡»æ–¹æ¡ˆ
    var fileInput = document.getElementById('file-input');
    var uploadArea = document.getElementById('file-upload-area');
    var uploadedFiles = [];
    
    // ä½¿ç”¨addEventListenerç»‘å®šchangeäº‹ä»¶ï¼ˆæ›´å¯é ï¼‰
    if (fileInput) {
      fileInput.addEventListener('change', function(e) {
        console.log('File input change event triggered');
        handleFiles(this.files);
      });
    }

    function handleFiles(files) {
      console.log('handleFiles called, files:', files ? files.length : 0);
      
      // å…¼å®¹å¤„ç†ï¼šç¡®ä¿filesæ˜¯æœ‰æ•ˆçš„FileList
      if (!files || files.length === 0) {
        console.log('No files selected');
        return;
      }

      var container = document.getElementById('file-list');
      var listDiv = document.getElementById('file-items');
      if (!container || !listDiv) {
        console.error('Container not found');
        return;
      }

      // è½¬ä¸ºæ•°ç»„å¤„ç†ï¼Œå…¼å®¹ä¸åŒæµè§ˆå™¨
      var filesArray = Array.from(files);
      
      for (var i = 0; i < filesArray.length; i++) {
        var file = filesArray[i];
        console.log('Processing file:', file.name, 'size:', file.size);

        // æ£€æŸ¥å¤§å°ï¼ˆ20MBï¼‰
        if (file.size > 20 * 1024 * 1024) {
          alert('æ–‡ä»¶è¿‡å¤§ï¼š' + file.name + 'ï¼Œé™åˆ¶ï¼š20MB');
          continue;
        }

        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
        var exists = false;
        for (var j = 0; j < uploadedFiles.length; j++) {
          if (uploadedFiles[j].name === file.name && uploadedFiles[j].size === file.size) {
            exists = true;
            break;
          }
        }

        if (!exists) {
          uploadedFiles.push(file);
          addFileToList(file);
          console.log('File added:', file.name);
        }
      }

      if (uploadedFiles.length > 0) {
        container.style.display = 'block';
        updateFileCount();
      }

      // é‡è¦ï¼šé‡ç½®inputä»¥å…è®¸é‡å¤é€‰æ‹©ç›¸åŒæ–‡ä»¶
      var input = document.getElementById('file-input');
      if (input) {
        input.value = '';
        // åä¸ºç­‰æ‰‹æœºå¯èƒ½éœ€è¦é‡æ–°åˆ›å»ºinput
        try {
          var newInput = input.cloneNode(true);
          input.parentNode.replaceChild(newInput, input);
          newInput.addEventListener('change', function(e) {
            handleFiles(this.files);
          });
        } catch(e) {
          console.log('Reset input error:', e);
        }
      }
    }

    function addFileToList(file) {
      var listDiv = document.getElementById('file-items');
      if (!listDiv) return;

      var ext = file.name.split('.').pop().toLowerCase();
      var icon = 'ğŸ“';
      if (['jpg','jpeg','png','gif','webp'].includes(ext)) icon = 'ğŸ–¼ï¸';
      else if (ext === 'pdf') icon = 'ğŸ“„';
      else if (['doc','docx'].includes(ext)) icon = 'ğŸ“';
      else if (['xls','xlsx'].includes(ext)) icon = 'ğŸ“Š';

      var size = file.size < 1024 * 1024 ? (file.size / 1024).toFixed(1) + ' KB' : (file.size / 1024 / 1024).toFixed(1) + ' MB';

      var item = document.createElement('div');
      item.style.cssText = 'display:flex;align-items:center;padding:8px 12px;background:rgba(0,0,0,0.2);border-radius:8px;margin-bottom:8px;animation:slideIn 0.3s;';
      item.innerHTML = '<div style="width:32px;height:32px;background:rgba(102,126,234,0.2);border-radius:6px;display:flex;align-items:center;justify-content:center;margin-right:10px;font-size:16px;">' + icon + '</div>' +
        '<div style="flex:1;min-width:0;"><div style="color:#e2e8f0;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + file.name + '</div>' +
        '<div style="color:#64748b;font-size:11px;">' + size + '</div></div>' +
        '<button onclick="deleteFile(' + (uploadedFiles.length - 1) + ')" style="width:28px;height:28px;background:rgba(239,68,68,0.1);border:none;border-radius:6px;color:#ef4444;font-size:16px;cursor:pointer;" title="åˆ é™¤">Ã—</button>';

      listDiv.appendChild(item);
    }

    function updateFileCount() {
      var countEl = document.querySelector('#file-list p');
      if (countEl) countEl.textContent = 'å·²ä¸Šä¼ æ–‡ä»¶ (' + uploadedFiles.length + 'ä¸ª)ï¼š';
    }

    function deleteFile(index) {
      if (index >= 0 && index < uploadedFiles.length) {
        uploadedFiles.splice(index, 1);
        // é‡æ–°æ¸²æŸ“
        var listDiv = document.getElementById('file-items');
        listDiv.innerHTML = '';
        for (var i = 0; i < uploadedFiles.length; i++) {
          (function(idx) {
            var file = uploadedFiles[idx];
            var ext = file.name.split('.').pop().toLowerCase();
            var icon = 'ğŸ“';
            if (['jpg','jpeg','png','gif','webp'].includes(ext)) icon = 'ğŸ–¼ï¸';
            else if (ext === 'pdf') icon = 'ğŸ“„';
            else if (['doc','docx'].includes(ext)) icon = 'ğŸ“';
            else if (['xls','xlsx'].includes(ext)) icon = 'ğŸ“Š';
            var size = file.size < 1024 * 1024 ? (file.size / 1024).toFixed(1) + ' KB' : (file.size / 1024 / 1024).toFixed(1) + ' MB';
            var item = document.createElement('div');
            item.style.cssText = 'display:flex;align-items:center;padding:8px 12px;background:rgba(0,0,0,0.2);border-radius:8px;margin-bottom:8px;animation:slideIn 0.3s;';
            item.innerHTML = '<div style="width:32px;height:32px;background:rgba(102,126,234,0.2);border-radius:6px;display:flex;align-items:center;justify-content:center;margin-right:10px;font-size:16px;">' + icon + '</div>' +
              '<div style="flex:1;min-width:0;"><div style="color:#e2e8f0;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + file.name + '</div>' +
              '<div style="color:#64748b;font-size:11px;">' + size + '</div></div>' +
              '<button onclick="deleteFile(' + idx + ')" style="width:28px;height:28px;background:rgba(239,68,68,0.1);border:none;border-radius:6px;color:#ef4444;font-size:16px;cursor:pointer;">Ã—</button>';
            listDiv.appendChild(item);
          })(i);
        }
        updateFileCount();
        if (uploadedFiles.length === 0) {
          document.getElementById('file-list').style.display = 'none';
        }
      }
    }

    // æ·»åŠ  CSS åŠ¨ç”»
    var style = document.createElement('style');
    style.textContent = '@keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }';
    document.head.appendChild(style);

    // å…¨å±€é”™è¯¯å¤„ç† - è¯¦ç»†ç‰ˆ
    window.onerror = function(msg, url, line, col, error) {
      console.error("JSé”™è¯¯:", msg, "è¡Œ:", line, "åˆ—:", col);
      alert("é”™è¯¯è¯¦æƒ…:\n" + msg + "\n\nä½ç½®: è¡Œ " + line + ", åˆ— " + col + "\n\nè¯·æˆªå›¾æ­¤é”™è¯¯ä¿¡æ¯");
      return false;
    };

    // æ•è·æœªå¤„ç†çš„Promiseé”™è¯¯
    window.addEventListener('unhandledrejection', function(event) {
      console.error('æœªå¤„ç†çš„Promiseé”™è¯¯:', event.reason);
      alert('Promiseé”™è¯¯: ' + event.reason);
    });

    const submitBtn = document.getElementById('submit-btn');
    const resetBtn = document.getElementById('reset-btn');
    const userInput = document.getElementById('user-input');
    const progressSection = document.querySelector('.progress-section');
    const progressFill = document.querySelector('.progress-fill');
    const progressPercentage = document.getElementById('progress-percentage');
    const statusText = document.getElementById('status-text');
    const resultSection = document.querySelector('.result-section');
    const resultContainer = document.getElementById('result-container');

    // æ£€æŸ¥æ˜¯å¦æœ‰é¢„å¡«å……å†…å®¹ï¼ˆä»çŸ¥è¯†åº“è¯¦æƒ…é¡µè·³è½¬è¿‡æ¥ï¼‰
    const prefillContent = localStorage.getItem('diyici_prefill');
    if (prefillContent && userInput) {
      userInput.value = prefillContent;
      localStorage.removeItem('diyici_prefill'); // æ¸…é™¤ï¼Œé¿å…é‡å¤å¡«å……
      // æ˜¾ç¤ºæç¤º
      if (statusText) {
        statusText.textContent = 'å·²åŠ è½½çŸ¥è¯†åº“æ–¹æ¡ˆï¼Œè¯·è¡¥å……æ‚¨çš„å…·ä½“éœ€æ±‚åç‚¹å‡»å¼€å§‹æ‰§è¡Œ';
        statusText.style.color = '#10b981';
      }
    }

    // æ£€æŸ¥URLå‚æ•°æ˜¯å¦æœ‰ä½¿ç”¨æŸä¸ªæ–¹æ¡ˆçš„è¯·æ±‚
    let useTitle = null;
    try {
      const urlParams = new URLSearchParams(window.location.search);
      useTitle = urlParams.get('use');
      if (useTitle) {
        useTitle = decodeURIComponent(useTitle);
      }
    } catch (e) {
      console.warn('URLå‚æ•°è§£æå¤±è´¥:', e);
      useTitle = null;
    }
    if (useTitle && userInput) {
      const prompt = `æˆ‘æƒ³åˆ›å»ºä¸€ä¸ªç±»ä¼¼ã€Œ${useTitle}ã€çš„æ–¹æ¡ˆï¼Œä½†é’ˆå¯¹æˆ‘çš„å…·ä½“éœ€æ±‚è¿›è¡Œè°ƒæ•´ï¼š\n\næˆ‘çš„å…·ä½“éœ€æ±‚æ˜¯ï¼š`;
      userInput.value = prompt;
      // æ¸…é™¤URLå‚æ•°
      window.history.replaceState({}, document.title, window.location.pathname);
    }

    // ä¸¥æ ¼æ¨¡å¼ç›¸å…³
    const strictModeCheckbox = document.getElementById('strict-mode');
    const strictModeInfo = document.getElementById('strict-mode-info');
    const strictModeLabel = document.getElementById('strict-mode-label');

    // ç›‘å¬ä¸¥æ ¼æ¨¡å¼å˜åŒ–
    strictModeCheckbox.addEventListener('change', () => {
      if (strictModeCheckbox.checked) {
        strictModeInfo.style.display = 'block';
        strictModeLabel.style.color = '#fbbf24';
      } else {
        strictModeInfo.style.display = 'none';
        strictModeLabel.style.color = '#94a3b8';
      }
    });

    async function extractFileContent(file, retryCount = 0) {
      return new Promise(async (resolve) => {
        try {
          // å›¾ç‰‡æ–‡ä»¶ - è°ƒç”¨åç«¯ OCR æœåŠ¡
          if (file.type.startsWith('image/')) {
          try {
            const formData = new FormData();
            formData.append('file', file);

            // å¢åŠ è¶…æ—¶å¤„ç†
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 30000); // 30ç§’è¶…æ—¶

            const response = await fetch('https://diyici.ai/api/ocr/recognize', {
              method: 'POST',
              body: formData,
              signal: controller.signal
            });

            clearTimeout(timeoutId);

            const result = await response.json();

            if (result.success && result.text && result.text.trim()) {
              resolve('\n\nã€ç”¨æˆ·ä¸Šä¼ çš„äº§å“å›¾ç‰‡ - éœ€è¦å¤åˆ»/åˆ†æã€‘\næ–‡ä»¶å: ' + file.name + '\nOCRè¯†åˆ«å†…å®¹ï¼ˆäº§å“æ ‡ç­¾æ–‡å­—ï¼‰ï¼š\n---\n' + result.text + '\n---\n\næ³¨æ„ï¼šç”¨æˆ·å¸Œæœ›åŸºäºè¿™ä¸ªäº§å“å›¾ç‰‡è¿›è¡Œå¤åˆ»æˆ–åˆ†æï¼Œè¯·æ ¹æ®OCRè¯†åˆ«çš„äº§å“ä¿¡æ¯ï¼ˆäº§å“åç§°ã€æˆåˆ†ã€è¥å…»æˆåˆ†ã€å“ç‰Œç­‰ï¼‰æä¾›è¯¦ç»†çš„å¤åˆ»æ–¹æ¡ˆã€‚');
            } else if (result.success) {
              // OCRæˆåŠŸä½†ç»“æœä¸ºç©ºï¼Œå°è¯•é‡è¯•ä¸€æ¬¡
              if (retryCount < 1) {
                console.log('OCRç»“æœä¸ºç©ºï¼Œé‡è¯•ä¸­... (' + (retryCount + 1) + '/2)');
                setTimeout(() => {
                  extractFileContent(file, retryCount + 1).then(resolve);
                }, 1000);
                return;
              }
              resolve('\n\nã€ç”¨æˆ·ä¸Šä¼ çš„äº§å“å›¾ç‰‡ - éœ€è¦å¤åˆ»/åˆ†æã€‘\næ–‡ä»¶å: ' + file.name + '\nâš ï¸ å›¾ç‰‡OCRè¯†åˆ«å¤±è´¥æˆ–å›¾ç‰‡ä¸­æ²¡æœ‰å¯è¯†åˆ«æ–‡å­—\nè¯·åŸºäºæ–‡ä»¶åå’Œç”¨æˆ·çš„"å¤åˆ»å›¾ä¸­äº§å“"æŒ‡ä»¤ï¼Œè¯¢é—®ç”¨æˆ·éœ€è¦å¤åˆ»ä»€ä¹ˆäº§å“æˆ–è¯·ç”¨æˆ·æè¿°äº§å“å†…å®¹ã€‚');
            } else {
              // è¯†åˆ«å¤±è´¥ï¼Œå°è¯•é‡è¯•ä¸€æ¬¡
              if (retryCount < 1) {
                console.log('OCRå¤±è´¥ï¼Œé‡è¯•ä¸­... (' + (retryCount + 1) + '/2)');
                setTimeout(() => {
                  extractFileContent(file, retryCount + 1).then(resolve);
                }, 1000);
                return;
              }
              resolve('\n\nã€ç”¨æˆ·ä¸Šä¼ çš„äº§å“å›¾ç‰‡ - éœ€è¦å¤åˆ»/åˆ†æã€‘\næ–‡ä»¶å: ' + file.name + '\nâŒ OCRè¯†åˆ«å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯') + '\nè¯·åŸºäºæ–‡ä»¶åå’Œç”¨æˆ·çš„"å¤åˆ»å›¾ä¸­äº§å“"æŒ‡ä»¤ï¼Œè¯¢é—®ç”¨æˆ·éœ€è¦å¤åˆ»ä»€ä¹ˆäº§å“æˆ–è¯·ç”¨æˆ·æè¿°äº§å“å†…å®¹ã€‚');
            /* è¶…å°å±å¹•éšè—éƒ¨åˆ†å¯¼èˆª */
            @media (max-width: 380px) {
                .nav-link:not(.nav-link-primary) {
                    font-size: 11px;
                    padding: 5px 6px;
                }
            }
            }
          } catch (error) {
            // è¯·æ±‚å¤±è´¥ï¼Œå°è¯•é‡è¯•ä¸€æ¬¡
            if (retryCount < 1) {
              console.log('OCRè¯·æ±‚å¤±è´¥ï¼Œé‡è¯•ä¸­... (' + (retryCount + 1) + '/2)');
              setTimeout(() => {
                extractFileContent(file, retryCount + 1).then(resolve);
              }, 1000);
              return;
            }
            resolve('\n\nã€ç”¨æˆ·ä¸Šä¼ çš„äº§å“å›¾ç‰‡ - éœ€è¦å¤åˆ»/åˆ†æã€‘\næ–‡ä»¶å: ' + file.name + '\nâŒ OCRæœåŠ¡è¿æ¥å¤±è´¥: ' + error.message + '\nè¯·åŸºäºæ–‡ä»¶åå’Œç”¨æˆ·çš„"å¤åˆ»å›¾ä¸­äº§å“"æŒ‡ä»¤ï¼Œè¯¢é—®ç”¨æˆ·éœ€è¦å¤åˆ»ä»€ä¹ˆäº§å“æˆ–è¯·ç”¨æˆ·æè¿°äº§å“å†…å®¹ã€‚');
          }
          return;
        }

        // PDF æ–‡ä»¶
        if (file.type === 'application/pdf') {
          resolve('[PDFæ–‡ä»¶: ' + file.name + ']\næ–‡ä»¶å¤§å°: ' + (file.size / 1024).toFixed(1) + ' KB\n\næ³¨ï¼šPDF å†…å®¹æå–éœ€è¦åç«¯æ”¯æŒã€‚å½“å‰æ‚¨å¯ä»¥æ‰‹åŠ¨ç²˜è´´ PDF ä¸­çš„å…³é”®å†…å®¹ã€‚');
          return;
        }

        // Word æ–‡ä»¶
        if (file.type.includes('word') || file.name.endsWith('.doc') || file.name.endsWith('.docx')) {
          resolve('[Wordæ–‡æ¡£: ' + file.name + ']\næ–‡ä»¶å¤§å°: ' + (file.size / 1024).toFixed(1) + ' KB\n\næ³¨ï¼šWord å†…å®¹æå–éœ€è¦åç«¯æ”¯æŒã€‚å½“å‰æ‚¨å¯ä»¥æ‰‹åŠ¨ç²˜è´´æ–‡æ¡£ä¸­çš„å…³é”®å†…å®¹ã€‚');
          return;
        }

        // æ–‡æœ¬æ–‡ä»¶
        const reader = new FileReader();
        reader.onload = (e) => {
          resolve(e.target.result);
        };
        reader.onerror = () => {
          resolve(`[æ–‡ä»¶è¯»å–å¤±è´¥: ${file.name}]`);
        };
        reader.readAsText(file);
        } catch (error) {
          console.error('æå–æ–‡ä»¶å†…å®¹æ—¶å‡ºé”™:', error);
          resolve('[æ–‡ä»¶å¤„ç†å¤±è´¥: ' + file.name + ' - ' + error.message + ']');
        }
      });
    }

    let pollingInterval;

    // iOS Safari é”™è¯¯è¯Šæ–­
    window.onerror = function(msg, url, line, col, error) {
      alert('JSé”™è¯¯: ' + msg + '\nè¡Œå·: ' + line + '\nåˆ—å·: ' + col + '\nURL: ' + url);
      console.error('Global error:', {msg, url, line, col, error});
      return false;
    };

    submitBtn.addEventListener('click', async () => {
      const inputText = userInput.value.trim();

      if (!inputText && uploadedFiles.length === 0) {
        alert('è¯·è¾“å…¥éœ€æ±‚å†…å®¹æˆ–ä¸Šä¼ æ–‡ä»¶');
        return;
      }

      // é‡ç½®çŠ¶æ€
      progressSection.style.display = 'block';
      resultSection.style.display = 'none';
      progressFill.style.width = '0%';
      progressPercentage.textContent = '0%';
      statusText.textContent = 'æ­£åœ¨å¤„ç†æ–‡ä»¶...';
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span>å¤„ç†ä¸­...</span>';
      resetBtn.disabled = true;

      try {
        // å¤„ç†ä¸Šä¼ çš„æ–‡ä»¶
        let fileContents = '';
        if (uploadedFiles.length > 0) {
          for (const file of uploadedFiles) {
            try {
              statusText.textContent = 'æ­£åœ¨è¯†åˆ« ' + file.name + '...';
              const content = await extractFileContent(file);
              fileContents += '\n\n=== æ–‡ä»¶: ' + file.name + ' ===\n' + content;
            } catch (fileError) {
              console.error('å¤„ç†æ–‡ä»¶ ' + file.name + ' æ—¶å‡ºé”™:', fileError);
              fileContents += '\n\n=== æ–‡ä»¶: ' + file.name + ' ===\n[æ–‡ä»¶å¤„ç†å¤±è´¥: ' + fileError.message + ']';
            }
          }
        }

        // åˆå¹¶æ–‡æœ¬å’Œæ–‡ä»¶å†…å®¹
        let combinedText = inputText + fileContents;
        
        // æå–çº¯ OCR æ–‡æœ¬ï¼ˆç”¨äºåç«¯è¯†åˆ«ï¼‰
        let ocrResult = '';
        if (uploadedFiles.length > 0) {
          for (const file of uploadedFiles) {
            try {
              const content = await extractFileContent(file);
              // æå–çº¯ OCR æ–‡æœ¬ï¼Œå»æ‰æç¤ºè¯­
              const ocrMatch = content.match(/OCRè¯†åˆ«å†…å®¹ï¼ˆäº§å“æ ‡ç­¾æ–‡å­—ï¼‰ï¼š\n---\n([\s\S]*?)\n---/);
              if (ocrMatch && ocrMatch[1] && ocrMatch[1].trim()) {
                ocrResult += '\n=== ' + file.name + ' ===\n' + ocrMatch[1].trim();
              }
            } catch (e) {
              console.error('æå– OCR æ–‡æœ¬å¤±è´¥:', e);
            }
          }
        }

        // ä¸¥æ ¼æ¨¡å¼ï¼šè‡ªåŠ¨æ·»åŠ å¼ºåŒ–è¦æ±‚
        const strictMode = document.getElementById('strict-mode').checked;
        if (strictMode) {
          const strictPrefix = `ã€ä¸¥æ ¼æ¨¡å¼ - å¼ºåˆ¶è¦æ±‚ã€‘\n\nä»¥ä¸‹è¦æ±‚å¿…é¡»ä¸¥æ ¼éµå®ˆï¼Œå¦åˆ™è¾“å‡ºå°†è¢«è§†ä¸ºä¸åˆæ ¼ï¼š\n\n1. æ‰€æœ‰ç›®æ ‡å¿…é¡»é‡åŒ–ï¼ˆå«å…·ä½“æ•°å­—ã€ç™¾åˆ†æ¯”ã€æ—¶é—´èŠ‚ç‚¹ï¼‰\n2. æ¯ä¸ªæ­¥éª¤å¿…é¡»æœ‰ï¼šåšä»€ä¹ˆ + æ€ä¹ˆåš + éªŒæ”¶æ ‡å‡†ï¼ˆå¯éªŒè¯ï¼‰\n3. æ‰€æœ‰èµ„æºå¿…é¡»æ˜ç¡®ï¼šäººåŠ›ï¼ˆå‡ äººï¼‰ã€é¢„ç®—ï¼ˆå¤šå°‘é’±ï¼‰ã€å·¥å…·ï¼ˆä»€ä¹ˆè½¯ä»¶/è®¾å¤‡ï¼‰ã€æ—¶é—´ï¼ˆå‡ å¤©/å‡ å°æ—¶ï¼‰\n4. æ‰€æœ‰é£é™©å¿…é¡»æœ‰ï¼šå…·ä½“é—®é¢˜ + åº”å¯¹æ–¹æ¡ˆï¼ˆä¸æ˜¯"æ³¨æ„é£é™©"ï¼‰\n5. ç¦æ­¢å‡ºç°ï¼š\n   - "æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´"\n   - "å»ºè®®è€ƒè™‘"\n   - "é€‚å½“ä¼˜åŒ–"\n   - "çµæ´»å¤„ç†"\n   - ä»»ä½•æ— æ³•é‡åŒ–éªŒè¯çš„è¡¨è¿°\n\n6. å¿…é¡»æä¾›ï¼š\n   - æ‰§è¡Œæ¸…å•ï¼ˆchecklistï¼Œå¯å‹¾é€‰ï¼‰\n   - è¯æœ¯/æ¨¡æ¿ï¼ˆç›´æ¥å¤åˆ¶å¯ç”¨ï¼‰\n   - è‡ªæŸ¥è¡¨ï¼ˆæ‰§è¡Œå‰/ä¸­/åæ£€æŸ¥ä»€ä¹ˆï¼‰\n\nã€ç”¨æˆ·åŸå§‹éœ€æ±‚ã€‘\n`;
          combinedText = strictPrefix + combinedText;
        }

        // åˆå§‹åŒ–æ­¥éª¤çŠ¶æ€
        initializeWorkflowSteps();

        // è°ƒç”¨ API åˆ›å»ºä»»åŠ¡
        statusText.textContent = 'æäº¤ä»»åŠ¡...';
        
        // å®‰å…¨åœ°æ„é€ è¯·æ±‚æ•°æ®
        let requestBody;
        try {
          requestBody = JSON.stringify({ 
            text: String(combinedText || ''), 
            ocrResult: String(ocrResult || '') 
          });
        } catch (jsonError) {
          console.error('JSONåºåˆ—åŒ–å¤±è´¥:', jsonError);
          throw new Error('è¯·æ±‚æ•°æ®æ ¼å¼é”™è¯¯');
        }
        
        const response = await fetch('https://diyici.ai/api/cabinet/run', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: requestBody
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'åˆ›å»ºä»»åŠ¡å¤±è´¥');
        }

        const taskId = data.taskId;

        // å¼€å§‹è½®è¯¢çŠ¶æ€
        let retryCount = 0;
        const maxRetries = 600; // æœ€å¤šè½®è¯¢ 10 åˆ†é’Ÿï¼ˆåº”å¯¹å¤æ‚ä»»åŠ¡ï¼‰
        const startTime = Date.now();

        pollingInterval = setInterval(async () => {
          try {
            // æ˜¾ç¤ºå·²ç”¨æ—¶
            const elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);
            const elapsedText = elapsedSeconds < 60
              ? `${elapsedSeconds}ç§’`
              : `${Math.floor(elapsedSeconds / 60)}åˆ†${elapsedSeconds % 60}ç§’`;

            const statusResponse = await fetch(`https://diyici.ai/api/cabinet/status/${taskId}`);
            const statusData = await statusResponse.json();

            if (!statusResponse.ok) {
              throw new Error(statusData.error || 'æŸ¥è¯¢çŠ¶æ€å¤±è´¥');
            }

            // æ›´æ–°è¿›åº¦
            const progress = statusData.progress;
            progressFill.style.width = `${progress}%`;
            progressPercentage.textContent = `${progress}%`;

            // æ›´æ–°çŠ¶æ€æ–‡æœ¬ï¼ˆåŒ…å«å·²ç”¨æ—¶ï¼‰
            const statusMap = {
              pending: 'ç­‰å¾…ä¸­...',
              planning: 'è°‹å±€è€…æ­£åœ¨åˆ¶å®šè¡ŒåŠ¨æŒ‡å—...',
              executing: 'æ‰§è¡Œè€…æ­£åœ¨æ‰§è¡Œä»»åŠ¡...',
              reviewing: 'æ‰¾èŒ¬è€…æ­£åœ¨å®¡æ ¸æˆæœ...',
              finalizing: 'æ²‰æ·€è€…æ­£åœ¨ç”Ÿæˆæ¨¡æ¿...',
              completed: 'ä»»åŠ¡å®Œæˆ',
              failed: 'ä»»åŠ¡å¤±è´¥'
            };

            const baseStatus = statusMap[statusData.status] || statusData.status;
            statusText.textContent = baseStatus + 'ï¼ˆå·²ç”¨æ—¶ ' + elapsedText + 'ï¼‰';

            // è¶…æ—¶æé†’ï¼ˆè¶…è¿‡5åˆ†é’Ÿï¼‰
            if (elapsedSeconds > 300 && statusData.status !== 'completed' && statusData.status !== 'failed') {
              statusText.innerHTML = '';
              statusText.appendChild(document.createTextNode(baseStatus + 'ï¼ˆå·²ç”¨æ—¶ ' + elapsedText + 'ï¼‰'));
              const remindSpan = document.createElement('span');
              remindSpan.style.cssText = 'font-size: 12px; color: #f59e0b; display: block; margin-top: 4px;';
              remindSpan.textContent = 'â³ ä»»åŠ¡è¾ƒå¤æ‚ï¼Œè¯·è€å¿ƒç­‰å¾…...';
              statusText.appendChild(remindSpan);
            }

            // æ›´æ–°å¯è§†åŒ–æ­¥éª¤
            updateWorkflowSteps(statusData);

            // å®æ—¶æ˜¾ç¤ºå„è§’è‰²è¾“å‡º
            if (statusData.planningResult || statusData.executionResult || statusData.reviewResult) {
              displayRealtimeOutput(statusData);
            }

            // æ£€æŸ¥æ˜¯å¦å®Œæˆ
            if (statusData.status === 'completed' || statusData.status === 'failed') {
              clearInterval(pollingInterval);

              if (statusData.status === 'completed') {
                // è·å–ç»“æœ
                const resultResponse = await fetch(`https://diyici.ai/api/cabinet/result/${taskId}`);
                const resultData = await resultResponse.json();

                if (!resultResponse.ok) {
                  throw new Error(resultData.error || 'è·å–ç»“æœå¤±è´¥');
                }

                // æ˜¾ç¤ºç»“æœ
                displayResult(resultData);
              } else {
                // æ˜¾ç¤ºå¤±è´¥è¯¦æƒ…
                displayFailure(statusData);
              }

              // æ¢å¤æŒ‰é’®çŠ¶æ€
              submitBtn.disabled = false;
              submitBtn.innerHTML = '<span>å¼€å§‹æ‰§è¡Œ</span>';
              resetBtn.disabled = false;
            }

            retryCount++;
            if (retryCount >= maxRetries) {
              clearInterval(pollingInterval);
              statusText.textContent = 'ä»»åŠ¡æ‰§è¡Œè¶…æ—¶';
              submitBtn.disabled = false;
              submitBtn.innerHTML = '<span>å¼€å§‹æ‰§è¡Œ</span>';
              resetBtn.disabled = false;
            }

          } catch (error) {
            clearInterval(pollingInterval);
            statusText.textContent = `é”™è¯¯: ${error.message}`;
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<span>å¼€å§‹æ‰§è¡Œ</span>';
            resetBtn.disabled = false;
          }
        }, 1000); // æ¯ç§’è½®è¯¢ä¸€æ¬¡

      } catch (error) {
        console.error('æ‰§è¡Œé”™è¯¯:', error);
        statusText.textContent = `é”™è¯¯: ${error.message || 'æœªçŸ¥é”™è¯¯'}`;
        statusText.style.color = '#ef4444';
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<span>å¼€å§‹æ‰§è¡Œ</span>';
        resetBtn.disabled = false;
      }
    });

    resetBtn.addEventListener('click', () => {
      // æ¸…é™¤ç”¨æˆ·è¾“å…¥
      userInput.value = '';

      // éšè—è¿›åº¦å’Œç»“æœåŒºåŸŸ
      progressSection.style.display = 'none';
      resultSection.style.display = 'none';

      // æ¸…é™¤å·²ä¸Šä¼ æ–‡ä»¶
      uploadedFiles.length = 0;
      document.getElementById('file-items').innerHTML = '';
      document.getElementById('file-list').style.display = 'none';

      // é‡ç½®ä¸¥æ ¼æ¨¡å¼
      strictModeCheckbox.checked = false;
      strictModeInfo.style.display = 'none';
      strictModeLabel.style.color = '#94a3b8';

      // æ¸…é™¤è½®è¯¢å®šæ—¶å™¨
      if (pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
      }

      // æ¢å¤æŒ‰é’®çŠ¶æ€
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<span>å¼€å§‹æ‰§è¡Œ</span>';
      resetBtn.disabled = false;

      // é‡ç½®è¿›åº¦æ¡
      progressFill.style.width = '0%';
      progressPercentage.textContent = '0%';
      statusText.textContent = '';
      statusText.style.color = '';

      // æ¸…ç©ºç»“æœå®¹å™¨
      resultContainer.innerHTML = '';

      // é‡ç½®å·¥ä½œæµæ­¥éª¤æ˜¾ç¤º
      initializeWorkflowSteps();

      // æ³¨æ„ï¼šä¸å†è‡ªåŠ¨æ»šåŠ¨ï¼Œå› ä¸ºé‡ç½®æŒ‰é’®å°±åœ¨è¾“å…¥æ¡†é™„è¿‘ï¼Œæ»šåŠ¨åè€Œä¼šè®©è¾“å…¥æ¡†ç¦»å¼€è§†é‡
    });

    function displayResult(result) {
      resultSection.style.display = 'block';
      resultContainer.innerHTML = '';

      // ğŸ¯ æ·»åŠ ä¸“ä¸šç»Ÿè®¡é¢æ¿
      addStatsPanel(result);

      // æ˜¾ç¤ºå„æ­¥éª¤ç»“æœ
      if (result.planningResult) {
        addResultCard('ğŸ§  é¦–è¾…ï¼ˆè°‹å±€ï¼‰', 'åˆ†æéœ€æ±‚å¹¶åˆ¶å®šè¯¦ç»†çš„è¡ŒåŠ¨æŒ‡å—', result.planningResult, 'planning');
      }

      if (result.executionResult) {
        addResultCard('ğŸ‘¨â€ğŸ’» å¹²åï¼ˆæ‰§è¡Œï¼‰', 'æ ¹æ®è¡ŒåŠ¨æŒ‡å—æ‰§è¡Œä»»åŠ¡', result.executionResult, 'execution');
      }

      if (result.reviewResult) {
        addResultCard('ğŸ” å¾¡å²ï¼ˆå®¡æŸ¥ï¼‰', 'å®¡æ ¸æ‰§è¡Œæˆæœå¹¶æå‡ºæ”¹è¿›æ„è§', result.reviewResult, 'review');
      }

      if (result.finalResult) {
        addResultCard('ğŸ“š å²å®˜ï¼ˆæ²‰æ·€ï¼‰', 'æ€»ç»“æµç¨‹å¹¶æå–å…³é”®ä¿¡æ¯', result.finalResult, 'final');
      }

      if (result.template) {
        addResultCard('ğŸ“‹ ä¸‡èƒ½æ¨¡æ¿', 'å¯å¤ç”¨çš„æ ‡å‡†åŒ–æµç¨‹æ¨¡æ¿', result.template, 'template');
      }

      // æ·»åŠ ä¸‹è½½æŒ‰é’®ï¼ˆåŒ…å«å‘å¸ƒé€‰é¡¹ï¼‰
      addDownloadButtons(result);

      // æ·»åŠ æ•´ä½“ä¼˜åŒ–æŒ‰é’®
      addOptimizeButton(result);

      // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
      resultSection.scrollIntoView({ behavior: 'smooth' });
    }

    // è‡ªåŠ¨å‘å¸ƒå¼¹çª—
    function showAutoPublishModal(result) {
      // æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¾ç¤ºè¿‡ï¼ˆé¿å…é‡å¤ï¼‰
      if (document.getElementById('auto-publish-modal')) return;

      const modal = document.createElement('div');
      modal.id = 'auto-publish-modal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 20px; box-sizing: border-box;';

      // æå–æ ‡é¢˜
      const defaultTitle = result.user_input ? result.user_input.substring(0, 30) + (result.user_input.length > 30 ? '...' : '') : 'æœªå‘½åæ–¹æ¡ˆ';

      // æå–å†…å®¹æ‘˜è¦
      const summary = result.finalResult ? result.finalResult.substring(0, 100) + '...' :
                     (result.template ? result.template.substring(0, 100) + '...' : '');

      modal.innerHTML = `
        <div style="background: linear-gradient(135deg, #1a1a3e, #2d2d5a); border-radius: 20px; padding: 28px; max-width: 520px; width: 100%; max-height: 85vh; overflow-y: auto; -webkit-overflow-scrolling: touch; border: 1px solid rgba(245,158,11,0.4); box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
          <div style="text-align: center; margin-bottom: 20px;">
            <div style="font-size: 48px; margin-bottom: 12px;">ğŸ‰</div>
            <h3 style="color: #fff; font-size: 20px; margin-bottom: 8px;">æ­å–œä½ å®Œæˆç¬¬ä¸€æ¬¡ç³»ç»ŸåŒ–ï¼</h3>
            <p style="color: #94a3b8; font-size: 14px;">ä½ çš„æ–¹æ¡ˆå·²å®Œæˆï¼Œç°åœ¨å¯ä»¥<span style="color: #f59e0b; font-weight: 600;">æˆä¸ºå¼€åˆ›è€…</span>ï¼Œè®©æ–¹æ¡ˆè¢«æ›´å¤šäººå¤ç”¨ã€‚</p>
          </div>

          <div style="background: rgba(245,158,11,0.1); border: 1px solid rgba(245,158,11,0.3); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
            <div style="color: #f59e0b; font-size: 13px; margin-bottom: 8px; font-weight: 600;">ğŸ‘¤ å¼€åˆ›è€…èº«ä»½</div>
            <p style="color: #e2e8f0; font-size: 13px; line-height: 1.6;">å‘å¸ƒåˆ°çŸ¥è¯†åº“åï¼Œä½ å°†è·å¾—å”¯ä¸€çš„<span style="color: #f59e0b;">å¼€åˆ›è€…æ ‡è¯†</span>ï¼Œè®°å½•ä½ çš„è´¡çŒ®ï¼Œè®©æ›´å¤šäººå—ç›Šäºä½ çš„æ™ºæ…§ã€‚</p>
          </div>

          <div style="background: rgba(255,255,255,0.05); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
            <div style="color: #667eea; font-size: 13px; margin-bottom: 8px; font-weight: 600;">ğŸ“‹ æ–¹æ¡ˆé¢„è§ˆ</div>
            <div style="color: #e2e8f0; font-size: 14px; font-weight: 600; margin-bottom: 8px;">${defaultTitle}</div>
            <div style="color: #94a3b8; font-size: 12px; line-height: 1.6;">${summary}</div>
          </div>

          <div style="margin-bottom: 16px;">
            <label style="display: block; color: #94a3b8; font-size: 13px; margin-bottom: 6px;">æ ‡é¢˜ *</label>
            <input type="text" id="auto-pub-title" value="${defaultTitle}" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #fff; font-size: 14px; box-sizing: border-box;">
          </div>

          <div style="margin-bottom: 16px;">
            <label style="display: block; color: #94a3b8; font-size: 13px; margin-bottom: 6px;">å¼€åˆ›è€…åç§° *</label>
            <input type="text" id="auto-pub-creator" placeholder="ç»™è‡ªå·±èµ·ä¸ªåå­—ï¼Œè®©å¤§å®¶è®°ä½ä½ ..." style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #fff; font-size: 14px; box-sizing: border-box;">
            <p style="color: #64748b; font-size: 11px; margin-top: 4px;">å¦‚ä¸å¡«å†™ï¼Œå°†è‡ªåŠ¨ç”ŸæˆåŒ¿åå¼€åˆ›è€…æ ‡è¯†</p>
          </div>

          <div style="margin-bottom: 16px;">
            <label style="display: block; color: #94a3b8; font-size: 13px; margin-bottom: 6px;">åˆ†ç±»</label>
            <select id="auto-pub-category" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #fff; font-size: 14px; box-sizing: border-box;">
              <option value="è¥é”€æ–¹æ¡ˆ">è¥é”€æ–¹æ¡ˆ</option>
              <option value="äº§å“è§„åˆ’">äº§å“è§„åˆ’</option>
              <option value="è¿è¥ç­–ç•¥">è¿è¥ç­–ç•¥</option>
              <option value="å†…å®¹åˆ›ä½œ">å†…å®¹åˆ›ä½œ</option>
              <option value="å…¶ä»–">å…¶ä»–</option>
            </select>
          </div>

          <div style="margin-bottom: 24px;">
            <label style="display: block; color: #94a3b8; font-size: 13px; margin-bottom: 6px;">ä¸€å¥è¯ç®€ä»‹</label>
            <textarea id="auto-pub-summary" rows="2" placeholder="ç®€è¦æè¿°è¿™ä¸ªæ–¹æ¡ˆèƒ½è§£å†³ä»€ä¹ˆé—®é¢˜..." style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #fff; font-size: 14px; box-sizing: border-box; resize: vertical;"></textarea>
          </div>

          <div style="display: flex; gap: 12px;">
            <button id="auto-pub-skip" style="flex: 1; padding: 14px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; color: #94a3b8; font-size: 14px; cursor: pointer; transition: all 0.3s;">ä¸‹æ¬¡å†è¯´</button>
            <button id="auto-pub-submit" style="flex: 1; padding: 14px; background: linear-gradient(135deg, #f59e0b, #d97706); border: none; border-radius: 10px; color: #fff; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s;">âœ¨ æˆä¸ºå¼€åˆ›è€…</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);

      // è·³è¿‡æŒ‰é’®
      document.getElementById('auto-pub-skip').onclick = () => {
        modal.remove();
        // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸï¼Œè®©ç”¨æˆ·çœ‹åˆ°å®Œæ•´ç»“æœ
        resultSection.scrollIntoView({ behavior: 'smooth' });
      };

      // å‘å¸ƒæŒ‰é’®
      document.getElementById('auto-pub-submit').onclick = async () => {
        const title = document.getElementById('auto-pub-title').value.trim();
        const category = document.getElementById('auto-pub-category').value;
        const summary = document.getElementById('auto-pub-summary').value.trim();
        const customCreator = document.getElementById('auto-pub-creator').value.trim();

        if (!title) {
          alert('è¯·è¾“å…¥æ ‡é¢˜');
          return;
        }

        // æ„å»ºå®Œæ•´å†…å®¹
        const fullContent = `# ${title}\n\n` +
          `**åˆ†ç±»**: ${category}\n` +
          `**å‘å¸ƒæ—¶é—´**: ${new Date().toLocaleString('zh-CN')}\n\n` +
          `## æ–¹æ¡ˆç®€ä»‹\n${summary || 'æš‚æ— ç®€ä»‹'}\n\n` +
          `---\n\n` +
          `## è¯¦ç»†å†…å®¹\n\n` +
          (result.planningResult ? `### é¦–è¾…ï¼ˆè°‹å±€ï¼‰åˆ†æ\n${result.planningResult}\n\n` : '') +
          (result.executionResult ? `### æ‰§è¡Œè€…æ–¹æ¡ˆ\n${result.executionResult}\n\n` : '') +
          (result.reviewResult ? `### å¾¡å²ï¼ˆå®¡æŸ¥ï¼‰å®¡æ ¸\n${result.reviewResult}\n\n` : '') +
          (result.finalResult ? `### å²å®˜ï¼ˆæ²‰æ·€ï¼‰æ€»ç»“\n${result.finalResult}\n\n` : '') +
          (result.template ? `### ä¸‡èƒ½æ¨¡æ¿\n${result.template}\n\n` : '');

        // æ˜¾ç¤ºå‘å¸ƒä¸­çŠ¶æ€
        const submitBtn = document.getElementById('auto-pub-submit');
        submitBtn.innerHTML = 'â³ å‘å¸ƒä¸­...';
        submitBtn.disabled = true;

        try {
          const response = await fetch('/api/knowledge/publish', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              title,
              category,
              summary,
              content: fullContent,
              creator: customCreator || undefined
            })
          });

          if (response.ok) {
            const data = await response.json();
            const category = data.data?.category || 'å·²åˆ†ç±»';
            const creator = data.data?.creator || 'å¼€åˆ›è€…';
            const autoCategorized = data.data?.autoCategorized;

            modal.innerHTML = `
              <div style="text-align: center; padding: 40px 20px;">
                <div style="font-size: 64px; margin-bottom: 20px;">âœ…</div>
                <h3 style="color: #fff; font-size: 22px; margin-bottom: 12px;">æ­å–œæˆä¸ºå¼€åˆ›è€…ï¼</h3>
                <p style="color: #94a3b8; font-size: 14px; margin-bottom: 20px;">ä½ çš„æ–¹æ¡ˆå·²è¿›å…¥çŸ¥è¯†åº“ï¼Œ<span style="color: #f59e0b;">å¼€åˆ›è€…èº«ä»½å·²æ¿€æ´»</span></p>

                <div style="background: rgba(255,255,255,0.05); border-radius: 12px; padding: 16px; margin-bottom: 24px; text-align: left;">
                  <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                    <span style="color: #94a3b8; font-size: 13px;">ğŸ·ï¸ è‡ªåŠ¨åˆ†ç±»</span>
                    <span style="color: #10b981; font-size: 13px; font-weight: 600;">${category} ${autoCategorized ? '(æ™ºèƒ½è¯†åˆ«)' : ''}</span>
                  </div>
                  <div style="display: flex; justify-content: space-between;">
                    <span style="color: #94a3b8; font-size: 13px;">ğŸ‘¤ å¼€åˆ›è€…èº«ä»½</span>
                    <span style="color: #f59e0b; font-size: 13px; font-weight: 600;">${creator}</span>
                  </div>
                </div>

                <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                  <button id="close-modal-btn" style="padding: 12px 24px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #94a3b8; font-size: 14px; font-weight: 600; cursor: pointer;">å…³é—­å¹¶ä¸‹è½½æˆæœ</button>
                  <button id="view-kb-btn" style="padding: 12px 24px; background: linear-gradient(135deg, #667eea, #764ba2); border: none; border-radius: 8px; color: #fff; font-size: 14px; font-weight: 600; cursor: pointer;">ğŸ“š æŸ¥çœ‹çŸ¥è¯†åº“</button>
                  <button id="next-task-btn" style="padding: 12px 24px; background: linear-gradient(135deg, #f59e0b, #d97706); border: none; border-radius: 8px; color: #fff; font-size: 14px; font-weight: 600; cursor: pointer;">å¼€å¯ä¸‹ä¸€æ¬¡ç³»ç»ŸåŒ–</button>
                </div>
                
                <!-- åˆ†äº«åŠŸèƒ½ -->
                <div style="margin-top: 24px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); text-align: center;">
                  <p style="color: #94a3b8; font-size: 13px; margin-bottom: 12px;">åˆ†äº«ç»™æœ‹å‹ï¼Œå¸®åŠ©æ›´å¤šäºº</p>
                  <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                    <button onclick="shareToQQ('${title}', '${data.data?.id || ''}')" style="padding: 10px 20px; background: #12B7F5; border: none; border-radius: 8px; color: #fff; font-size: 13px; cursor: pointer;">ğŸ§ QQ</button>
                    <button onclick="shareToWeChat('${title}', '${data.data?.id || ''}')" style="padding: 10px 20px; background: #07C160; border: none; border-radius: 8px; color: #fff; font-size: 13px; cursor: pointer;">ğŸ’¬ å¾®ä¿¡</button>
                    <button onclick="copyShareLink('${data.data?.id || ''}')" style="padding: 10px 20px; background: rgba(102, 126, 234, 0.3); border: 1px solid rgba(102, 126, 234, 0.5); border-radius: 8px; color: #fff; font-size: 13px; cursor: pointer;">ğŸ”— å¤åˆ¶é“¾æ¥</button>
                  </div>
                </div>
              </div>
            `;

            // ç»‘å®šæŒ‰é’®äº‹ä»¶
            document.getElementById('close-modal-btn').onclick = () => {
              modal.remove();
              // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸï¼Œæ–¹ä¾¿ç”¨æˆ·ä¸‹è½½
              resultSection.scrollIntoView({ behavior: 'smooth' });
            };

            document.getElementById('view-kb-btn').onclick = () => {
              window.open('/knowledge.html', '_blank');
            };

            document.getElementById('next-task-btn').onclick = () => {
              modal.remove();
              // æ»šåŠ¨åˆ°é¡¶éƒ¨ï¼Œå‡†å¤‡æ–°ä»»åŠ¡
              window.scrollTo({ top: 0, behavior: 'smooth' });
              // æ¸…ç©ºè¾“å…¥æ¡†
              userInput.value = '';
              // æ¸…ç©ºç»“æœåŒºåŸŸ
              resultSection.style.display = 'none';
              resultContainer.innerHTML = '';
            };
          } else {
            throw new Error('å‘å¸ƒå¤±è´¥');
          }
        } catch (error) {
          alert('âŒ å‘å¸ƒå¤±è´¥: ' + error.message);
          submitBtn.innerHTML = 'ğŸ’¾ å‘å¸ƒåˆ°çŸ¥è¯†åº“';
          submitBtn.disabled = false;
        }
      };
    }

    // åˆ†äº«åŠŸèƒ½
    function shareToQQ(title, id) {
      const url = 'https://diyici.ai/knowledge.html?id=' + id;
      const shareUrl = `https://connect.qq.com/widget/shareqq/index.html?url=${encodeURIComponent(url)}&title=${encodeURIComponent(title)}&source=${encodeURIComponent('diyici.ai æ•°å­—å†…é˜')}`;
      window.open(shareUrl, '_blank', 'width=600,height=500');
    }

    function shareToWeChat(title, id) {
      const url = 'https://diyici.ai/knowledge.html?id=' + id;
      // å¾®ä¿¡åˆ†äº«éœ€è¦ä½¿ç”¨å¾®ä¿¡ JS-SDK æˆ–ç”ŸæˆäºŒç»´ç 
      // è¿™é‡Œç®€å•å¤åˆ¶é“¾æ¥ï¼Œç”¨æˆ·å¯ä»¥æ‰‹åŠ¨ç²˜è´´åˆ°å¾®ä¿¡
      copyToClipboard(url);
      alert('é“¾æ¥å·²å¤åˆ¶ï¼è¯·ç²˜è´´åˆ°å¾®ä¿¡èŠå¤©çª—å£åˆ†äº«');
    }

    function copyShareLink(id) {
      const url = 'https://diyici.ai/knowledge.html?id=' + id;
      copyToClipboard(url);
      alert('åˆ†äº«é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
    }

    function copyToClipboard(text) {
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(text);
      } else {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-9999px';
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
      }
    }

    // æ·»åŠ æ•´ä½“ä¼˜åŒ–æŒ‰é’®
    function addOptimizeButton(result) {
      const optimizeCard = document.createElement('div');
      optimizeCard.className = 'result-card';
      optimizeCard.style.cssText = 'background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1)); border: 1px solid rgba(16, 185, 129, 0.3); margin-top: 24px;';

      optimizeCard.innerHTML = `
        <div class="result-header">
          <div class="result-icon" style="background: linear-gradient(135deg, #10b981, #059669);">ğŸ”„</div>
          <div class="result-title">
            <h3>ç»§ç»­ä¼˜åŒ–æ–¹æ¡ˆ</h3>
            <p>åŸºäºå½“å‰ç»“æœè¿›è¡Œè¿­ä»£æ”¹è¿›</p>
          </div>
        </div>
        <div class="result-content" style="margin-top: 16px;">
          <p style="color: #94a3b8; margin-bottom: 12px;">å¯¹æ•´ä½“æ–¹æ¡ˆä¸æ»¡æ„ï¼Ÿå¯ä»¥åŸºäºå½“å‰æˆæœç»§ç»­è¿­ä»£ä¼˜åŒ–ã€‚</p>
          <div id="optimize-btn-container" style="text-align: center;"></div>
        </div>
      `;

      resultContainer.appendChild(optimizeCard);

      // åˆ›å»ºä¼˜åŒ–æŒ‰é’®
      const btnContainer = optimizeCard.querySelector('#optimize-btn-container');
      const optimizeBtn = document.createElement('button');
      optimizeBtn.style.cssText = 'padding: 12px 24px; background: linear-gradient(135deg, #10b981, #059669); border: none; border-radius: 8px; color: #fff; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s;';
      optimizeBtn.innerHTML = 'ğŸš€ åŸºäºå½“å‰æ–¹æ¡ˆç»§ç»­ä¼˜åŒ–';
      optimizeBtn.onclick = function() {
        // å›åˆ°é¡¶éƒ¨
        window.scrollTo({ top: 0, behavior: 'smooth' });

        // æ„å»ºä¸Šä¸‹æ–‡æ‘˜è¦
        const summary = [];
        if (result.planningResult) summary.push('ã€é¦–è¾…ï¼ˆè°‹å±€ï¼‰åˆ†æã€‘' + result.planningResult.substring(0, 200) + '...');
        if (result.executionResult) summary.push('ã€æ‰§è¡Œè€…æ–¹æ¡ˆã€‘' + result.executionResult.substring(0, 200) + '...');
        if (result.finalResult) summary.push('ã€å²å®˜ï¼ˆæ²‰æ·€ï¼‰æ€»ç»“ã€‘' + result.finalResult.substring(0, 200) + '...');

        const context = `ã€åŸºäºå®Œæ•´æ–¹æ¡ˆç»§ç»­ä¼˜åŒ–ã€‘\n\nä¹‹å‰å›¢é˜Ÿåä½œç”Ÿæˆçš„æ–¹æ¡ˆæ ¸å¿ƒå†…å®¹ï¼š\n\n${summary.join('\n\n')}\n\næˆ‘éœ€è¦è¿›ä¸€æ­¥ä¼˜åŒ–å’Œå®Œå–„ï¼š\n`;

        userInput.value = context;
        userInput.focus();

        // æ¸…ç©ºä¹‹å‰çš„ç»“æœåŒºåŸŸ
        resultSection.style.display = 'none';
        resultContainer.innerHTML = '';

        // æ˜¾ç¤ºæç¤º
        statusText.textContent = 'å·²åŠ è½½å®Œæ•´æ–¹æ¡ˆä¸Šä¸‹æ–‡ï¼Œè¯·è¡¥å……ä¼˜åŒ–éœ€æ±‚åç‚¹å‡»å¼€å§‹æ‰§è¡Œ';
        statusText.style.color = '#10b981';
      };

      btnContainer.appendChild(optimizeBtn);
    }

    // ğŸ“Š æ·»åŠ ä¸“ä¸šç»Ÿè®¡é¢æ¿
    function addStatsPanel(result) {
      const statsCard = document.createElement('div');
      statsCard.className = 'result-card';
      statsCard.style.cssText = 'background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1)); border: 1px solid rgba(102, 126, 234, 0.3);';

      // è®¡ç®—ç»Ÿè®¡æ•°æ®ï¼ˆå…¼å®¹ä¸¤ç§å­—æ®µå‘½åï¼‰
      const planningChars = (result.planningResult || result.planningResult || '').length;
      const executionChars = (result.executionResult || result.executionResult || '').length;
      const reviewChars = (result.reviewResult || result.reviewResult || '').length;
      const finalChars = (result.finalResult || result.finalResult || '').length;
      const templateChars = (result.template || '').length;
      const totalChars = planningChars + executionChars + reviewChars + finalChars + templateChars;

      // è®¡ç®—å‚ä¸è§’è‰²æ•°
      let roleCount = 0;
      if (planningChars > 0) roleCount++;
      if (executionChars > 0) roleCount++;
      if (reviewChars > 0) roleCount++;
      if (finalChars > 0) roleCount++;

      // è®¡ç®—å„è§’è‰²è¿ç®—æ¬¡æ•°ï¼ˆæœ‰å†…å®¹=1æ¬¡ï¼Œå¦‚æœæœ‰retry_countåˆ™ç´¯åŠ ï¼‰
      const planningOps = planningChars > 0 ? 1 : 0;
      const executionOps = executionChars > 0 ? 1 : 0;
      const reviewOps = reviewChars > 0 ? 1 : 0;
      const finalOps = finalChars > 0 ? 1 : 0;
      const totalOps = planningOps + executionOps + reviewOps + finalOps;

      const reviewCount = result.retry_count || result.retryCount || 1;
      const qualityScore = Math.min(95, 70 + reviewCount * 5);

      // æ ¼å¼åŒ–æ•°å­— - ä½¿ç”¨å­—ç¬¦ä¸²å¤„ç†ä»£æ›¿æ­£åˆ™
      const formatNumber = (num) => {
        return num.toLocaleString().split(',').join('');
      };

      // åˆ›å»ºå¤´éƒ¨
      const header = document.createElement('div');
      header.className = 'result-header';
      header.innerHTML = `
        <div class="result-icon" style="background: linear-gradient(135deg, #667eea, #764ba2);">ğŸ“Š</div>
        <div class="result-title">
          <h3>æ‰§è¡Œç»Ÿè®¡æŠ¥å‘Š</h3>
          <p>å›¢é˜Ÿåä½œå·¥ä½œé‡æ¦‚è§ˆ</p>
        </div>
      `;
      statsCard.appendChild(header);

      // åˆ›å»ºå†…å®¹åŒº
      const content = document.createElement('div');
      content.className = 'result-content';
      content.style.marginTop = '16px';

      // æ ¸å¿ƒæŒ‡æ ‡ - æ”¹ä¸º4åˆ—ï¼Œå¢åŠ è¿ç®—æ¬¡æ•°
      const coreMetrics = document.createElement('div');
      coreMetrics.style.cssText = 'display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px;';

      const metrics = [
        { value: roleCount, label: 'å‚ä¸è§’è‰²', color: '#667eea' },
        { value: totalOps, label: 'æ€»è¿ç®—æ¬¡æ•°', color: '#f59e0b' },
        { value: formatNumber(totalChars), label: 'æ€»å­—æ•°', color: '#10b981' },
        { value: reviewCount, label: 'å®¡æ ¸è½®æ¬¡', color: '#ec4899' }
      ];

      metrics.forEach(metric => {
        const metricDiv = document.createElement('div');
        metricDiv.style.cssText = 'text-align: center; padding: 16px 8px; background: rgba(255,255,255,0.05); border-radius: 12px; min-width: 0;';
        metricDiv.innerHTML = `
          <div style="font-size: 28px; font-weight: 700; color: ${metric.color}; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${metric.value}</div>
          <div style="font-size: 11px; color: #94a3b8; margin-top: 4px;">${metric.label}</div>
        `;
        coreMetrics.appendChild(metricDiv);
      });
      content.appendChild(coreMetrics);

      // å„è§’è‰²è¯¦ç»†ç»Ÿè®¡ï¼ˆåŒ…å«è¿ç®—æ¬¡æ•°ï¼‰
      const details = document.createElement('div');
      details.style.cssText = 'background: rgba(0,0,0,0.2); border-radius: 12px; padding: 16px; margin-bottom: 16px;';

      const detailsTitle = document.createElement('h4');
      detailsTitle.style.cssText = 'color: #e2e8f0; margin-bottom: 12px; font-size: 14px;';
      detailsTitle.textContent = 'ğŸ¤– å„è§’è‰²è¿ç®—ç»Ÿè®¡';
      details.appendChild(detailsTitle);

      const workloads = [
        { chars: planningChars, ops: planningOps, icon: 'ğŸ§ ', label: 'é¦–è¾…ï¼ˆè°‹å±€ï¼‰', color: '#667eea' },
        { chars: executionChars, ops: executionOps, icon: 'ğŸ‘¨â€ğŸ’»', label: 'å¹²åï¼ˆæ‰§è¡Œï¼‰', color: '#f093fb' },
        { chars: reviewChars, ops: reviewOps, icon: 'ğŸ”', label: 'å¾¡å²ï¼ˆå®¡æŸ¥ï¼‰', color: '#4facfe' },
        { chars: finalChars, ops: finalOps, icon: 'ğŸ“š', label: 'å²å®˜ï¼ˆæ²‰æ·€ï¼‰', color: '#f5576c' }
      ];

      workloads.forEach((work, index) => {
        if (work.chars > 0) {
          const workDiv = document.createElement('div');
          workDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.1);';
          if (index === workloads.filter(w => w.chars > 0).length - 1) {
            workDiv.style.borderBottom = 'none';
          }
          workDiv.innerHTML = `
            <div style="display: flex; align-items: center; gap: 12px;">
              <span style="font-size: 18px;">${work.icon}</span>
              <span style="color: ${work.color}; font-size: 14px;">${work.label}</span>
            </div>
            <div style="text-align: right;">
              <div style="color: #f59e0b; font-weight: 700; font-size: 16px;">è¿ç®— ${work.ops} æ¬¡</div>
              <div style="color: #94a3b8; font-size: 12px;">${formatNumber(work.chars)} å­—</div>
            </div>
          `;
          details.appendChild(workDiv);
        }
      });
      content.appendChild(details);

      // è´¨é‡è¯„ä¼°
      const quality = document.createElement('div');
      quality.style.cssText = 'display: flex; align-items: center; gap: 16px; padding: 16px; background: rgba(16, 185, 129, 0.1); border-radius: 12px;';
      quality.innerHTML = `
        <div style="font-size: 24px;">âœ¨</div>
        <div style="flex: 1;">
          <div style="color: #10b981; font-weight: 600; margin-bottom: 4px;">è´¨é‡è¯„ä¼°ï¼š${qualityScore} åˆ†</div>
          <div style="color: #94a3b8; font-size: 12px;">ç»è¿‡ ${reviewCount} è½®ä¸¥æ ¼å®¡æ ¸ï¼Œæ–¹æ¡ˆå·²è¾¾åˆ°å¯æ‰§è¡Œæ ‡å‡†</div>
        </div>
        <div style="font-size: 32px; font-weight: 700; color: #10b981;">${qualityScore}</div>
      `;
      content.appendChild(quality);

      statsCard.appendChild(content);
      resultContainer.appendChild(statsCard);
    }

    // æ·»åŠ ä¸‹è½½æŒ‰é’®
    function addDownloadButtons(result) {
      const downloadCard = document.createElement('div');
      downloadCard.className = 'result-card';
      downloadCard.style.borderLeft = '4px solid #10b981';
      downloadCard.style.marginTop = '24px';

      // è®¡ç®—ä»»åŠ¡è€—æ—¶
      const createdAt = result.createdAt ? new Date(result.createdAt) : null;
      const updatedAt = result.updatedAt ? new Date(result.updatedAt) : new Date();
      let durationText = 'è®¡ç®—ä¸­...';
      let durationSeconds = 0;

      if (createdAt) {
        const duration = updatedAt - createdAt;
        durationSeconds = Math.floor(duration / 1000);
        const minutes = Math.floor(durationSeconds / 60);
        const seconds = durationSeconds % 60;

        if (minutes > 0) {
          durationText = `${minutes}åˆ†${seconds}ç§’`;
        } else {
          durationText = `${seconds}ç§’`;
        }
      }

      // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
      const formatTime = (date) => {
        if (!date) return 'æœªçŸ¥';
        return new Date(date).toLocaleString('zh-CN', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        });
      };

      // æ”¶é›†æ‰€æœ‰å¯ä¸‹è½½å†…å®¹
      let fullContent = `# æ•°å­—å†…é˜æ‰§è¡Œç»“æœ\n\n`;
      fullContent += `â±ï¸ ä»»åŠ¡è€—æ—¶ç»Ÿè®¡\n`;
      fullContent += `- å¼€å§‹æ—¶é—´: ${formatTime(result.createdAt)}\n`;
      fullContent += `- å®Œæˆæ—¶é—´: ${formatTime(result.updatedAt)}\n`;
      fullContent += `- æ€»è€—æ—¶: ${durationText}\n`;
      fullContent += `- å®¡æ ¸è½®æ¬¡: ${result.retryCount || 0} è½®\n\n`;
      fullContent += `---\n\n`;

      // ç¡®ä¿æ‰€æœ‰å­—æ®µéƒ½æœ‰å†…å®¹ï¼ˆå³ä½¿æ²¡æœ‰ä¹Ÿæ˜¾ç¤ºå ä½ç¬¦ï¼‰
      fullContent += `## ä¸€ã€é¦–è¾…ï¼ˆè°‹å±€ï¼‰- è¡ŒåŠ¨æŒ‡å—\n\n${result.planningResult || 'ï¼ˆæš‚æ— å†…å®¹ï¼‰'}\n\n---\n\n`;
      fullContent += `## äºŒã€å¹²åï¼ˆæ‰§è¡Œï¼‰- æ‰§è¡Œæˆæœ\n\n${result.executionResult || 'ï¼ˆæš‚æ— å†…å®¹ï¼‰'}\n\n---\n\n`;
      fullContent += `## ä¸‰ã€å¾¡å²ï¼ˆå®¡æŸ¥ï¼‰- å®¡æ ¸æ„è§\n\n${result.reviewResult || 'ï¼ˆæš‚æ— å†…å®¹ï¼‰'}\n\n---\n\n`;
      fullContent += `## å››ã€å²å®˜ï¼ˆæ²‰æ·€ï¼‰- å®Œæ•´æ€»ç»“\n\n${result.finalResult || 'ï¼ˆæš‚æ— å†…å®¹ï¼‰'}\n\n---\n\n`;
      fullContent += `## äº”ã€ä¸‡èƒ½æ¨¡æ¿\n\n${result.template || 'ï¼ˆæš‚æ— å†…å®¹ï¼‰'}\n\n`;

      // åœ¨é¡µé¢ä¸­æ˜¾ç¤ºè€—æ—¶ä¿¡æ¯å¡ç‰‡
      const timeStatsCard = document.createElement('div');
      timeStatsCard.style.cssText = 'background: linear-gradient(135deg, rgba(102,126,234,0.1) 0%, rgba(118,75,162,0.1) 100%); border-radius: 12px; padding: 16px; margin-bottom: 16px; border: 1px solid rgba(102,126,234,0.3);';
      timeStatsCard.innerHTML = `
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
          <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px;">â±ï¸</div>
          <div>
            <div style="color: #fff; font-weight: 600; font-size: 16px;">ä»»åŠ¡æ‰§è¡Œç»Ÿè®¡</div>
            <div style="color: #94a3b8; font-size: 12px;">æœ¬æ¬¡ä»»åŠ¡çš„å®Œæ•´æ—¶é—´çº¿</div>
          </div>
        </div>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
          <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px;">
            <div style="color: #94a3b8; font-size: 11px; margin-bottom: 4px;">å¼€å§‹æ—¶é—´</div>
            <div style="color: #fff; font-size: 13px; font-weight: 500;">${formatTime(result.createdAt)}</div>
          </div>
          <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px;">
            <div style="color: #94a3b8; font-size: 11px; margin-bottom: 4px;">å®Œæˆæ—¶é—´</div>
            <div style="color: #fff; font-size: 13px; font-weight: 500;">${formatTime(result.updatedAt)}</div>
          </div>
          <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px;">
            <div style="color: #94a3b8; font-size: 11px; margin-bottom: 4px;">æ€»è€—æ—¶</div>
            <div style="color: #667eea; font-size: 18px; font-weight: 700;">${durationText}</div>
          </div>
          <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px;">
            <div style="color: #94a3b8; font-size: 11px; margin-bottom: 4px;">å®¡æ ¸è½®æ¬¡</div>
            <div style="color: #f59e0b; font-size: 18px; font-weight: 700;">${result.retryCount || 0} è½®</div>
          </div>
        </div>
      `;

      // åˆ›å»ºå¤´éƒ¨
      const header = document.createElement('div');
      header.className = 'result-header';
      header.innerHTML = `
        <div class="result-icon" style="background: linear-gradient(135deg, #10b981, #059669);">ğŸ’¾</div>
        <div class="result-title">
          <h3>ä¸‹è½½æˆæœ</h3>
          <p>ä¿å­˜æ‰§è¡Œç»“æœåˆ°æœ¬åœ°</p>
        </div>
      `;
      downloadCard.appendChild(header);

      // åˆ›å»ºå†…å®¹åŒº
      const content = document.createElement('div');
      content.className = 'result-content';
      content.style.marginTop = '16px';

      // å…ˆæ·»åŠ è€—æ—¶ç»Ÿè®¡å¡ç‰‡
      content.appendChild(timeStatsCard);

      // ä¸‹è½½æŒ‰é’®åŒºåŸŸ
      const downloadSection = document.createElement('div');
      downloadSection.style.cssText = 'margin-bottom: 16px;';

      const downloadLabel = document.createElement('div');
      downloadLabel.style.cssText = 'color: #94a3b8; font-size: 12px; margin-bottom: 8px;';
      downloadLabel.textContent = 'ğŸ“¥ ä¸‹è½½æˆæœåˆ°æœ¬åœ°ï¼ˆå·²åŒ…å«è€—æ—¶ç»Ÿè®¡ï¼‰';
      downloadSection.appendChild(downloadLabel);

      const downloadBtnContainer = document.createElement('div');
      downloadBtnContainer.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px;';

      // ä¸‹è½½æŒ‰é’®é…ç½®
      const downloadBtns = [
        { text: 'ğŸ“„ Markdown', color: 'linear-gradient(135deg, #667eea, #764ba2)', action: window.downloadMarkdown },
        { text: 'ğŸ“ HTML', color: 'linear-gradient(135deg, #f093fb, #f5576c)', action: window.downloadWord },
        { text: 'ğŸ“ƒ çº¯æ–‡æœ¬', color: 'linear-gradient(135deg, #4facfe, #00f2fe)', action: window.downloadText },
        { text: 'âš¡ Skill', color: 'linear-gradient(135deg, #f59e0b, #d97706)', action: window.downloadSkill },
        { text: 'ğŸ“‹ ä¸€é”®å¤åˆ¶', color: 'linear-gradient(135deg, #10b981, #059669)', action: window.copyFullContent }
      ];

      downloadBtns.forEach(btnConfig => {
        const btn = document.createElement('button');
        btn.style.cssText = 'padding: 10px 16px; background: ' + btnConfig.color + '; border: none; border-radius: 8px; color: #fff; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.3s ease;';
        btn.textContent = btnConfig.text;
        btn.onclick = btnConfig.action;
        downloadBtnContainer.appendChild(btn);
      });

      downloadSection.appendChild(downloadBtnContainer);
      content.appendChild(downloadSection);

      // åˆ†éš”çº¿
      const divider = document.createElement('div');
      divider.style.cssText = 'border-top: 1px solid rgba(255,255,255,0.1); margin: 16px 0;';
      content.appendChild(divider);

      // å‘å¸ƒåˆ°çŸ¥è¯†åº“åŒºåŸŸ
      const publishSection = document.createElement('div');

      const publishLabel = document.createElement('div');
      publishLabel.style.cssText = 'color: #94a3b8; font-size: 12px; margin-bottom: 8px;';
      publishLabel.textContent = 'ğŸŒŸ å¯é€‰ï¼šå‘å¸ƒåˆ°çŸ¥è¯†åº“ï¼ˆæˆä¸ºå¼€åˆ›è€…ï¼‰';
      publishSection.appendChild(publishLabel);

      const publishBtn = document.createElement('button');
      publishBtn.style.cssText = 'padding: 12px 24px; background: linear-gradient(135deg, #f59e0b, #d97706); border: none; border-radius: 8px; color: #fff; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s ease; width: 100%;';
      publishBtn.innerHTML = 'ğŸ’¾ å‘å¸ƒåˆ°çŸ¥è¯†åº“ï¼Œè®©æ›´å¤šäººå¤ç”¨';
      publishBtn.onclick = function() {
        window.publishToKnowledge(result);
      };
      publishSection.appendChild(publishBtn);

      const publishHint = document.createElement('div');
      publishHint.style.cssText = 'color: #64748b; font-size: 11px; margin-top: 6px;';
      publishHint.textContent = 'å‘å¸ƒåå¯è·å¾—å¼€åˆ›è€…æ ‡è¯†ï¼Œè®°å½•ä½ çš„è´¡çŒ®';
      publishSection.appendChild(publishHint);

      content.appendChild(publishSection);
      downloadCard.appendChild(content);
      resultContainer.appendChild(downloadCard);

      // å­˜å‚¨å†…å®¹ä¾›ä¸‹è½½ä½¿ç”¨
      window._downloadContent = fullContent;
      window._currentResult = result;
      window._taskStats = {
        createdAt: result.createdAt,
        updatedAt: result.updatedAt,
        duration: durationText,
        retryCount: result.retryCount || 0
      };
    }

    // ä¸‹è½½ Skill é…ç½® (YAMLæ ¼å¼)
    window.downloadSkill = function() {
      try {
        const result = window._currentResult;
        if (!result) {
          alert('æš‚æ— å†…å®¹å¯ä¸‹è½½');
          return;
        }

        // ç”Ÿæˆ YAML æ ¼å¼çš„ Skill é…ç½®
        const skillConfig = generateSkillConfig(result);
        
        const blob = new Blob([skillConfig], { type: 'text/yaml;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `skill_${result.id || 'config'}_${new Date().toISOString().slice(0, 10)}.yaml`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      } catch (error) {
        console.error('ä¸‹è½½Skillé…ç½®å¤±è´¥:', error);
        alert('ä¸‹è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    };

    // ç”Ÿæˆ Skill é…ç½®
    function generateSkillConfig(result) {
      const title = result.user_input ? result.user_input.substring(0, 30) : 'æœªå‘½åæŠ€èƒ½';
      const timestamp = new Date().toISOString();
      
      return `# Skill é…ç½®æ–‡ä»¶
# ç”± diyici.ai æ•°å­—å†…é˜è‡ªåŠ¨ç”Ÿæˆ
# ç”Ÿæˆæ—¶é—´: ${timestamp}

skill:
  name: "${title}"
  version: "1.0.0"
  description: "${result.user_input || ''}"
  
  # å…ƒæ•°æ®
  metadata:
    created_at: "${timestamp}"
    source: "diyici.ai"
    retry_count: ${result.retryCount || 0}
    
  # è¾“å…¥å‚æ•°å®šä¹‰
  inputs:
    - name: "user_requirement"
      type: "string"
      description: "ç”¨æˆ·éœ€æ±‚æè¿°"
      required: true
      
  # å·¥ä½œæµæ­¥éª¤
  workflow:
    - step: 1
      role: "é¦–è¾…(è°‹å±€è€…)"
      name: "planning"
      description: "åˆ¶å®šè¡ŒåŠ¨è®¡åˆ’"
      output: |
${(result.planningResult || '').split('\n').map(line => '        ' + line).join('\n')}
      
    - step: 2
      role: "å¹²å(æ‰§è¡Œè€…)"
      name: "execution"
      description: "äº§å‡ºæ‰§è¡Œæ–¹æ¡ˆ"
      output: |
${(result.executionResult || '').split('\n').map(line => '        ' + line).join('\n')}
      
    - step: 3
      role: "å¾¡å²(å®¡æŸ¥è€…)"
      name: "review"
      description: "è´¨é‡å®¡æ ¸"
      output: |
${(result.reviewResult || '').split('\n').map(line => '        ' + line).join('\n')}
      
    - step: 4
      role: "å²å®˜(æ²‰æ·€è€…)"
      name: "finalizing"
      description: "æ€»ç»“æ²‰æ·€"
      output: |
${(result.finalResult || '').split('\n').map(line => '        ' + line).join('\n')}
      
  # æ¨¡æ¿ (å¯å¤ç”¨)
  template:
    name: "ä¸‡èƒ½æ¨¡æ¿"
    content: |
${(result.template || '').split('\n').map(line => '      ' + line).join('\n')}
      
  # API é›†æˆé…ç½®
  api:
    endpoint: "https://diyici.ai/api/cabinet/run"
    method: "POST"
    headers:
      Content-Type: "application/json"
    
  # ä½¿ç”¨è¯´æ˜
  usage:
    description: "è¯¥Skillé…ç½®å¯è¢«å…¶ä»–ç³»ç»Ÿè°ƒç”¨ï¼Œå®ç°è‡ªåŠ¨åŒ–æ‰§è¡Œ"
    integration: |
      1. å¯¼å…¥æ­¤YAMLé…ç½®æ–‡ä»¶
      2. è°ƒç”¨ API ç«¯ç‚¹ä¼ å…¥éœ€æ±‚å‚æ•°
      3. ç³»ç»Ÿå°†è‡ªåŠ¨æ‰§è¡Œå››æ­¥æµç¨‹å¹¶è¿”å›ç»“æœ
      4. ç»“æœåŒ…å«å®Œæ•´æ–¹æ¡ˆã€æ‰§è¡Œæ¸…å•å’Œä¸‡èƒ½æ¨¡æ¿
`;
    }

    // ä¸€é”®å¤åˆ¶å®Œæ•´å†…å®¹
    window.copyFullContent = async function() {
      try {
        const content = window._downloadContent || '';
        if (!content) {
          alert('æš‚æ— å†…å®¹å¯å¤åˆ¶');
          return;
        }
        
        await navigator.clipboard.writeText(content);
        
        // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = 'âœ… å·²å¤åˆ¶';
        btn.style.opacity = '0.8';
        
        setTimeout(() => {
          btn.textContent = originalText;
          btn.style.opacity = '1';
        }, 2000);
        
      } catch (err) {
        console.error('å¤åˆ¶å¤±è´¥:', err);
        alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·ä½¿ç”¨ä¸‹è½½åŠŸèƒ½');
      }
    };

    // ä¸‹è½½ Markdown - ç¾åŒ–æ’ç‰ˆ
    window.downloadMarkdown = function() {
      try {
        let content = window._downloadContent || '';

        // ç¾åŒ–å¤„ç†ï¼šç¡®ä¿æ ‡é¢˜å’Œå†…å®¹ä¹‹é—´æœ‰ç©ºè¡Œï¼Œåˆ—è¡¨é¡¹æ•´é½
        const lines = content.split('\n');
        const beautifiedLines = [];
        let prevLine = '';

        for (let i = 0; i < lines.length; i++) {
          let line = lines[i];
          const trimmed = line.trim();

          // ç¡®ä¿æ ‡é¢˜å‰åæœ‰ç©ºè¡Œ
          if (trimmed.startsWith('#')) {
            if (beautifiedLines.length > 0 && prevLine !== '') {
              beautifiedLines.push('');
            }
            beautifiedLines.push(line);
            beautifiedLines.push('');
          }
          // å¤„ç†åˆ—è¡¨é¡¹ï¼Œç¡®ä¿ç¼©è¿›ä¸€è‡´
          else if (trimmed.startsWith('- ') || trimmed.startsWith('* ')) {
            // ç»Ÿä¸€ä½¿ç”¨ - ä½œä¸ºåˆ—è¡¨æ ‡è®°
            line = '  - ' + trimmed.slice(2);
            beautifiedLines.push(line);
          }
          // å¤„ç†æ•°å­—åˆ—è¡¨
          else if (/^\d+\.\s/.test(trimmed)) {
            line = '  ' + trimmed;
            beautifiedLines.push(line);
          }
          // å¤„ç†åˆ†éš”çº¿
          else if (trimmed === '---' || trimmed === '***') {
            beautifiedLines.push('');
            beautifiedLines.push('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
            beautifiedLines.push('');
          }
          // æ™®é€šæ®µè½
          else {
            beautifiedLines.push(line);
          }

          prevLine = trimmed;
        }

        // æ·»åŠ é¡µçœ‰é¡µè„š
        const stats = window._taskStats || {};
        const header = `â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    æ•°å­—å†…é˜æ‰§è¡ŒæˆæœæŠ¥å‘Š                          â•‘
â•‘  ç”Ÿæˆæ—¶é—´ï¼š${new Date().toLocaleString('zh-CN')}                              â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  â±ï¸ æ‰§è¡Œç»Ÿè®¡                                                   â•‘
â•‘  æ€»è€—æ—¶ï¼š${(stats.duration || 'è®¡ç®—ä¸­...').padEnd(47)}â•‘
â•‘  å®¡æ ¸è½®æ¬¡ï¼š${String(stats.retryCount || 0).padEnd(46)}è½®â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

`;

        const footer = `

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ“‹ æœ¬æŠ¥å‘Šç”±æ•°å­—å†…é˜è‡ªåŠ¨ç”Ÿæˆ
ğŸ¯ å››ä¸ªè§’è‰²ä¸€èµ·ï¼šè°‹å±€ â†’ æ‰§è¡Œ â†’ å®¡æŸ¥ â†’ æ•´ç†
â±ï¸ æ‰§è¡Œè€—æ—¶ï¼š${stats.duration || 'è®¡ç®—ä¸­...'}  |  å®¡æ ¸è½®æ¬¡ï¼š${stats.retryCount || 0} è½®
ğŸ”’ diyici.ai - é©¯æœç¡…åŸºæ€ªå…½çš„åˆ¶è¡¡å·¥å…·
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€`;

        const finalContent = header + beautifiedLines.join('\n') + footer;

        const blob = new Blob([finalContent], { type: 'text/markdown;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `æ•°å­—å†…é˜æˆæœ_${new Date().toISOString().slice(0, 10)}.md`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      } catch (error) {
        console.error('ä¸‹è½½Markdownå¤±è´¥:', error);
        // é™çº§åˆ°ç®€å•ä¸‹è½½
        const blob = new Blob([window._downloadContent], { type: 'text/markdown;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `æ•°å­—å†…é˜æˆæœ_${new Date().toISOString().slice(0, 10)}.md`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }
    };

    // ä¸‹è½½ Wordï¼ˆä½¿ç”¨ HTML æ ¼å¼ï¼Œä¿å­˜ä¸º .html æ–‡ä»¶ï¼‰- ä¸“ä¸šç¾åŒ–ç‰ˆ
    window.downloadWord = function() {
      try {
        let processedContent = (window._downloadContent || '');

        // è½¬æ¢ Markdown åˆ°ä¸“ä¸š HTML
        const lines = processedContent.split('\n');
        let htmlLines = [];
        let inList = false;
        let listType = ''; // 'ul' æˆ– 'ol'

        for (let i = 0; i < lines.length; i++) {
          let line = lines[i];
          let trimmed = line.trim();

          // å¤„ç†æ ‡é¢˜
          if (trimmed.startsWith('# ')) {
            if (inList) {
              htmlLines.push('</' + listType + '>');
              inList = false;
            }
            htmlLines.push('<h1>ğŸ“‹ ' + escapeHtml(trimmed.slice(2)) + '</h1>');
          }
          else if (trimmed.startsWith('## ')) {
            if (inList) {
              htmlLines.push('</' + listType + '>');
              inList = false;
            }
            htmlLines.push('<h2>â–¸ ' + escapeHtml(trimmed.slice(3)) + '</h2>');
          }
          else if (trimmed.startsWith('### ')) {
            if (inList) {
              htmlLines.push('</' + listType + '>');
              inList = false;
            }
            htmlLines.push('<h3>â—† ' + escapeHtml(trimmed.slice(4)) + '</h3>');
          }
          else if (trimmed.startsWith('#### ')) {
            if (inList) {
              htmlLines.push('</' + listType + '>');
              inList = false;
            }
            htmlLines.push('<h4>â—‡ ' + escapeHtml(trimmed.slice(5)) + '</h4>');
          }
          // å¤„ç†æ— åºåˆ—è¡¨
          else if (trimmed.startsWith('- ') || trimmed.startsWith('* ')) {
            if (!inList || listType !== 'ul') {
              if (inList) htmlLines.push('</' + listType + '>');
              htmlLines.push('<ul>');
              inList = true;
              listType = 'ul';
            }
            let itemContent = escapeHtml(trimmed.slice(2));
            itemContent = processInlineFormatting(itemContent);
            htmlLines.push('<li>' + itemContent + '</li>');
          }
          // å¤„ç†æœ‰åºåˆ—è¡¨
          else if (/^\d+\.\s/.test(trimmed)) {
            if (!inList || listType !== 'ol') {
              if (inList) htmlLines.push('</' + listType + '>');
              htmlLines.push('<ol>');
              inList = true;
              listType = 'ol';
            }
            let itemContent = escapeHtml(trimmed.replace(/^\d+\.\s/, ''));
            itemContent = processInlineFormatting(itemContent);
            htmlLines.push('<li>' + itemContent + '</li>');
          }
          // å¤„ç†åˆ†éš”çº¿
          else if (trimmed === '---' || trimmed === '***' || trimmed === '___') {
            if (inList) {
              htmlLines.push('</' + listType + '>');
              inList = false;
            }
            htmlLines.push('<hr class="divider">');
          }
          // å¤„ç†å¼•ç”¨å—
          else if (trimmed.startsWith('> ')) {
            if (inList) {
              htmlLines.push('</' + listType + '>');
              inList = false;
            }
            let quoteContent = escapeHtml(trimmed.slice(2));
            quoteContent = processInlineFormatting(quoteContent);
            htmlLines.push('<blockquote>' + quoteContent + '</blockquote>');
          }
          // å¤„ç†ä»£ç å—
          else if (trimmed.startsWith('```')) {
            if (inList) {
              htmlLines.push('</' + listType + '>');
              inList = false;
            }
            let codeLines = [];
            let j = i + 1;
            while (j < lines.length && !lines[j].trim().startsWith('```')) {
              codeLines.push(escapeHtml(lines[j]));
              j++;
            }
            htmlLines.push('<pre><code>' + codeLines.join('\n') + '</code></pre>');
            i = j;
          }
          // å¤„ç†æ™®é€šæ®µè½
          else if (trimmed !== '') {
            if (inList) {
              htmlLines.push('</' + listType + '>');
              inList = false;
            }
            let paraContent = escapeHtml(trimmed);
            paraContent = processInlineFormatting(paraContent);
            htmlLines.push('<p>' + paraContent + '</p>');
          }
          // ç©ºè¡Œ - æ·»åŠ é—´è·
          else {
            if (inList) {
              htmlLines.push('</' + listType + '>');
              inList = false;
            }
          }
        }

        // å…³é—­æœªé—­åˆçš„åˆ—è¡¨
        if (inList) {
          htmlLines.push('</' + listType + '>');
        }

        processedContent = htmlLines.join('\n');

        // HTML è½¬ä¹‰å‡½æ•°
        function escapeHtml(text) {
          const div = document.createElement('div');
          div.textContent = text;
          return div.innerHTML;
        }

        // å¤„ç†è¡Œå†…æ ¼å¼ï¼ˆç²—ä½“ã€æ–œä½“ã€ä»£ç ï¼‰
        function processInlineFormatting(text) {
          // ç²—ä½“ **text**
          text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
          // æ–œä½“ *text*
          text = text.replace(/\*([^\*]+)\*/g, '<em>$1</em>');
          // è¡Œå†…ä»£ç  `code`
          text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
          return text;
        }

        const htmlContent = `<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ•°å­—å†…é˜æ‰§è¡ŒæˆæœæŠ¥å‘Š</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600;700&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Noto Serif SC", "Microsoft YaHei", "SimSun", serif;
      line-height: 1.9;
      padding: 60px 50px;
      max-width: 900px;
      margin: 0 auto;
      color: #2c3e50;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      background-attachment: fixed;
    }

    .container {
      background: #fff;
      padding: 60px;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.1);
    }

    .header {
      text-align: center;
      padding-bottom: 40px;
      border-bottom: 3px solid #667eea;
      margin-bottom: 50px;
    }

    .header h1 {
      color: #1a1a3e;
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 15px;
      letter-spacing: 2px;
    }

    .header .subtitle {
      color: #667eea;
      font-size: 16px;
      font-weight: 600;
    }

    .header .meta {
      color: #7f8c8d;
      font-size: 13px;
      margin-top: 20px;
    }

    .header .stats {
      display: flex;
      justify-content: center;
      gap: 40px;
      margin-top: 20px;
      padding: 15px 30px;
      background: linear-gradient(135deg, rgba(102,126,234,0.1) 0%, rgba(118,75,162,0.1) 100%);
      border-radius: 10px;
      border: 1px solid rgba(102,126,234,0.2);
    }

    .header .stat-item {
      text-align: center;
    }

    .header .stat-value {
      color: #667eea;
      font-size: 24px;
      font-weight: 700;
    }

    .header .stat-label {
      color: #7f8c8d;
      font-size: 12px;
      margin-top: 4px;
    }

    h1 {
      color: #1a1a3e;
      font-size: 26px;
      font-weight: 700;
      margin: 40px 0 20px 0;
      padding-bottom: 12px;
      border-bottom: 2px solid #e8e8e8;
    }

    h2 {
      color: #667eea;
      font-size: 22px;
      font-weight: 600;
      margin: 35px 0 18px 0;
      padding-left: 15px;
      border-left: 4px solid #667eea;
    }

    h3 {
      color: #764ba2;
      font-size: 19px;
      font-weight: 600;
      margin: 28px 0 15px 0;
    }

    h4 {
      color: #4a5568;
      font-size: 17px;
      font-weight: 600;
      margin: 22px 0 12px 0;
    }

    p {
      margin: 14px 0;
      text-align: justify;
      text-indent: 2em;
    }

    ul, ol {
      margin: 18px 0 18px 30px;
      padding-left: 20px;
    }

    li {
      margin: 10px 0;
      line-height: 1.8;
    }

    ul li {
      list-style-type: none;
      position: relative;
      padding-left: 20px;
    }

    ul li::before {
      content: "â–¸";
      position: absolute;
      left: 0;
      color: #667eea;
      font-weight: bold;
    }

    ol li {
      color: #4a5568;
    }

    strong {
      color: #e53e3e;
      font-weight: 700;
      background: linear-gradient(transparent 60%, #fef3cd 60%);
      padding: 0 3px;
    }

    em {
      color: #764ba2;
      font-style: italic;
    }

    code {
      background: #f7fafc;
      color: #e53e3e;
      padding: 3px 8px;
      border-radius: 4px;
      font-family: "Consolas", "Monaco", monospace;
      font-size: 0.9em;
      border: 1px solid #e2e8f0;
    }

    pre {
      background: #2d3748;
      color: #e2e8f0;
      padding: 20px;
      border-radius: 10px;
      overflow-x: auto;
      margin: 20px 0;
    }

    pre code {
      background: transparent;
      color: inherit;
      padding: 0;
      border: none;
    }

    blockquote {
      background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
      border-left: 4px solid #667eea;
      padding: 20px 25px;
      margin: 25px 0;
      border-radius: 0 10px 10px 0;
      font-style: italic;
      color: #4a5568;
    }

    hr.divider {
      border: none;
      height: 2px;
      background: linear-gradient(90deg, transparent, #667eea, transparent);
      margin: 40px 0;
    }

    .footer {
      margin-top: 60px;
      padding-top: 30px;
      border-top: 2px solid #e8e8e8;
      text-align: center;
      color: #7f8c8d;
      font-size: 13px;
    }

    .footer .brand {
      color: #667eea;
      font-weight: 700;
      font-size: 15px;
    }

    @media print {
      body {
        background: white;
        padding: 20px;
      }
      .container {
        box-shadow: none;
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>æ•°å­—å†…é˜æ‰§è¡ŒæˆæœæŠ¥å‘Š</h1>
      <div class="subtitle">å››ä¸ªè§’è‰²ä¸€èµ· Â· æ·±åº¦å®šåˆ¶ Â· å¯è½åœ°æ‰§è¡Œæ–¹æ¡ˆ</div>
      <div class="stats">
        <div class="stat-item">
          <div class="stat-value">${stats.duration || 'è®¡ç®—ä¸­...'}</div>
          <div class="stat-label">æ€»è€—æ—¶</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">${stats.retryCount || 0}</div>
          <div class="stat-label">å®¡æ ¸è½®æ¬¡</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">4</div>
          <div class="stat-label">ååŒè§’è‰²</div>
        </div>
      </div>
      <div class="meta">ç”Ÿæˆæ—¶é—´ï¼š${new Date().toLocaleString('zh-CN', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      })}</div>
    </div>

    ${processedContent}

    <div class="footer">
      <div class="brand">ğŸ›ï¸ diyici.ai - æ•°å­—å†…é˜</div>
      <p>å››ä¸ªè§’è‰²ä¸€èµ·ï¼šè°‹å±€ â†’ æ‰§è¡Œ â†’ å®¡æŸ¥ â†’ æ•´ç†</p>
      <p>â±ï¸ æ‰§è¡Œè€—æ—¶ï¼š${stats.duration || 'è®¡ç®—ä¸­...'}  |  å®¡æ ¸è½®æ¬¡ï¼š${stats.retryCount || 0} è½®</p>
      <p>é©¯æœç¡…åŸºæ€ªå…½çš„åˆ¶è¡¡å·¥å…·</p>
    </div>
  </div>
</body>
</html>`;

        const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'æ•°å­—å†…é˜æˆæœ_' + new Date().toISOString().slice(0, 10) + '.html';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      } catch (error) {
        console.error('ä¸‹è½½Wordå¤±è´¥:', error);
        alert('ä¸‹è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    };

    // ä¸‹è½½çº¯æ–‡æœ¬ - ç¾åŒ–æ’ç‰ˆç‰ˆ
    window.downloadText = function() {
      try {
        const stats = window._taskStats || {};
        let content = window._downloadContent || '';
        const lines = content.split('\n');
        const beautifiedLines = [];
        let sectionNum = 0;
        let subsectionNum = 0;

        // æ·»åŠ é¡µçœ‰
        beautifiedLines.push('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
        beautifiedLines.push('â•‘                    æ•°å­—å†…é˜æ‰§è¡ŒæˆæœæŠ¥å‘Š                          â•‘');
        beautifiedLines.push('â•‘                                                                â•‘');
        beautifiedLines.push(`â•‘  ç”Ÿæˆæ—¶é—´ï¼š${new Date().toLocaleString('zh-CN').padEnd(47)}â•‘`);
        beautifiedLines.push('â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£');
        beautifiedLines.push(`â•‘  â±ï¸ æ‰§è¡Œè€—æ—¶ï¼š${(stats.duration || 'è®¡ç®—ä¸­...').padEnd(44)}â•‘`);
        beautifiedLines.push(`â•‘  ğŸ”„ å®¡æ ¸è½®æ¬¡ï¼š${String(stats.retryCount || 0).padEnd(44)}è½®â•‘`);
        beautifiedLines.push('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        beautifiedLines.push('');

        for (let i = 0; i < lines.length; i++) {
          let line = lines[i];
          let trimmed = line.trim();

          // å¤„ç†ä¸€çº§æ ‡é¢˜
          if (trimmed.startsWith('# ')) {
            sectionNum++;
            subsectionNum = 0;
            beautifiedLines.push('');
            beautifiedLines.push(`ã€${sectionNum}ã€‘${trimmed.slice(2)}`);
            beautifiedLines.push('â•'.repeat(60));
          }
          // å¤„ç†äºŒçº§æ ‡é¢˜
          else if (trimmed.startsWith('## ')) {
            subsectionNum++;
            beautifiedLines.push('');
            beautifiedLines.push(`  ${sectionNum}.${subsectionNum} ${trimmed.slice(3)}`);
            beautifiedLines.push('  ' + 'â”€'.repeat(50));
          }
          // å¤„ç†ä¸‰çº§æ ‡é¢˜
          else if (trimmed.startsWith('### ')) {
            beautifiedLines.push('');
            beautifiedLines.push(`    â–¶ ${trimmed.slice(4)}`);
          }
          // å¤„ç†å››çº§æ ‡é¢˜
          else if (trimmed.startsWith('#### ')) {
            beautifiedLines.push(`      â€¢ ${trimmed.slice(5)}`);
          }
          // å¤„ç†æ— åºåˆ—è¡¨
          else if (trimmed.startsWith('- ') || trimmed.startsWith('* ')) {
            let itemText = trimmed.slice(2);
            // ç§»é™¤ç²—ä½“æ ‡è®°
            itemText = itemText.replace(/\*\*/g, '');
            beautifiedLines.push(`      Â· ${itemText}`);
          }
          // å¤„ç†æœ‰åºåˆ—è¡¨
          else if (/^\d+\.\s/.test(trimmed)) {
            let itemText = trimmed.replace(/^\d+\.\s/, '');
            itemText = itemText.replace(/\*\*/g, '');
            beautifiedLines.push(`        ${itemText}`);
          }
          // å¤„ç†å¼•ç”¨
          else if (trimmed.startsWith('> ')) {
            beautifiedLines.push('');
            beautifiedLines.push(`    ã€Œ${trimmed.slice(2)}ã€`);
          }
          // å¤„ç†åˆ†éš”çº¿
          else if (trimmed === '---' || trimmed === '***') {
            beautifiedLines.push('');
            beautifiedLines.push('    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
            beautifiedLines.push('');
          }
          // å¤„ç†æ™®é€šæ®µè½
          else if (trimmed !== '') {
            // ç§»é™¤ç²—ä½“æ ‡è®°ï¼Œä¿ç•™å†…å®¹
            let paraText = trimmed.replace(/\*\*/g, '');
            // é¦–è¡Œç¼©è¿›
            beautifiedLines.push(`    ${paraText}`);
          }
          // ç©ºè¡Œä¿ç•™ä¸€ä¸ª
          else if (beautifiedLines[beautifiedLines.length - 1] !== '') {
            beautifiedLines.push('');
          }
        }

        // æ·»åŠ é¡µè„š
        beautifiedLines.push('');
        beautifiedLines.push('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
        beautifiedLines.push('');
        beautifiedLines.push(`  â±ï¸ æ‰§è¡Œè€—æ—¶ï¼š${stats.duration || 'è®¡ç®—ä¸­...'}  |  å®¡æ ¸è½®æ¬¡ï¼š${stats.retryCount || 0} è½®`);
        beautifiedLines.push('');
        beautifiedLines.push('  ğŸ“‹ æœ¬æŠ¥å‘Šç”±æ•°å­—å†…é˜è‡ªåŠ¨ç”Ÿæˆ');
        beautifiedLines.push('  ğŸ¯ å››ä¸ªè§’è‰²ä¸€èµ·ï¼šè°‹å±€ â†’ æ‰§è¡Œ â†’ å®¡æŸ¥ â†’ æ•´ç†');
        beautifiedLines.push('  ğŸ”’ diyici.ai - é©¯æœç¡…åŸºæ€ªå…½çš„åˆ¶è¡¡å·¥å…·');
        beautifiedLines.push('');
        beautifiedLines.push('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');

        const finalContent = beautifiedLines.join('\n');

        const blob = new Blob([finalContent], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'æ•°å­—å†…é˜æˆæœ_' + new Date().toISOString().slice(0, 10) + '.txt';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      } catch (error) {
        console.error('ä¸‹è½½æ–‡æœ¬å¤±è´¥:', error);
        alert('ä¸‹è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    };

    // å¤åˆ¶å†…å®¹åˆ°å‰ªè´´æ¿
    window.copyToClipboard = async function(button, text) {
      try {
        // ç›´æ¥æ¥æ”¶æ–‡æœ¬ï¼Œä¸éœ€è¦è§£ç 
        await navigator.clipboard.writeText(text || '');

        // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸ
        const originalText = button.innerHTML;
        button.innerHTML = 'âœ… å·²å¤åˆ¶';
        button.style.background = 'rgba(16, 185, 129, 0.2)';
        button.style.borderColor = '#10b981';
        button.style.color = '#10b981';

        setTimeout(() => {
          button.innerHTML = originalText;
          button.style.background = 'rgba(255,255,255,0.1)';
          button.style.borderColor = 'rgba(255,255,255,0.2)';
          button.style.color = '#94a3b8';
        }, 2000);
      } catch (err) {
        console.error('å¤åˆ¶å¤±è´¥:', err);
        alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
      }
    };

    // å‘å¸ƒåˆ°çŸ¥è¯†åº“
    window.publishToKnowledge = async function(result) {
      // åˆ›å»ºå‘å¸ƒè¡¨å•å¼¹çª—
      const modal = document.createElement('div');
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 20px; box-sizing: border-box;';

      // æå–æ ‡é¢˜ï¼ˆä»ç”¨æˆ·è¾“å…¥æˆ–æ¨¡æ¿ä¸­æå–ï¼‰
      const defaultTitle = result.user_input ? result.user_input.substring(0, 30) + '...' : 'æœªå‘½åæ–¹æ¡ˆ';

      modal.innerHTML = `
        <div style="background: #1a1a3e; border-radius: 16px; padding: 24px; max-width: 500px; width: 100%; max-height: 85vh; overflow-y: auto; -webkit-overflow-scrolling: touch; border: 1px solid rgba(102,126,234,0.3);">
          <h3 style="color: #fff; margin-bottom: 20px; font-size: 18px;">ğŸ’¾ å‘å¸ƒåˆ°çŸ¥è¯†åº“</h3>
          <p style="color: #94a3b8; font-size: 13px; margin-bottom: 16px;">åˆ†äº«ä½ çš„æ–¹æ¡ˆï¼Œè®©æ›´å¤šäººå—ç›Š</p>

          <div style="margin-bottom: 16px;">
            <label style="display: block; color: #94a3b8; font-size: 13px; margin-bottom: 6px;">æ ‡é¢˜ *</label>
            <input type="text" id="pub-title" value="${defaultTitle}" style="width: 100%; padding: 10px 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #fff; font-size: 14px; box-sizing: border-box;">
          </div>

          <div style="margin-bottom: 16px;">
            <label style="display: block; color: #94a3b8; font-size: 13px; margin-bottom: 6px;">å¼€åˆ›è€…åç§° *</label>
            <input type="text" id="pub-creator" placeholder="ç»™è‡ªå·±èµ·ä¸ªåå­—ï¼Œè®©å¤§å®¶è®°ä½ä½ ..." style="width: 100%; padding: 10px 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #fff; font-size: 14px; box-sizing: border-box;">
            <p style="color: #64748b; font-size: 11px; margin-top: 4px;">å¦‚ä¸å¡«å†™ï¼Œå°†è‡ªåŠ¨ç”ŸæˆåŒ¿åå¼€åˆ›è€…æ ‡è¯†</p>
          </div>

          <div style="margin-bottom: 16px;">
            <label style="display: block; color: #94a3b8; font-size: 13px; margin-bottom: 6px;">åˆ†ç±»</label>
            <select id="pub-category" style="width: 100%; padding: 10px 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #fff; font-size: 14px; box-sizing: border-box;">
              <option value="è¥é”€æ–¹æ¡ˆ">è¥é”€æ–¹æ¡ˆ</option>
              <option value="äº§å“è§„åˆ’">äº§å“è§„åˆ’</option>
              <option value="è¿è¥ç­–ç•¥">è¿è¥ç­–ç•¥</option>
              <option value="å†…å®¹åˆ›ä½œ">å†…å®¹åˆ›ä½œ</option>
              <option value="å…¶ä»–">å…¶ä»–</option>
            </select>
          </div>

          <div style="margin-bottom: 20px;">
            <label style="display: block; color: #94a3b8; font-size: 13px; margin-bottom: 6px;">ä¸€å¥è¯ç®€ä»‹</label>
            <textarea id="pub-summary" rows="2" placeholder="ç®€è¦æè¿°è¿™ä¸ªæ–¹æ¡ˆèƒ½è§£å†³ä»€ä¹ˆé—®é¢˜..." style="width: 100%; padding: 10px 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #fff; font-size: 14px; box-sizing: border-box; resize: vertical;"></textarea>
          </div>

          <div style="display: flex; gap: 12px; justify-content: flex-end;">
            <button id="pub-cancel" style="padding: 10px 20px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #94a3b8; font-size: 14px; cursor: pointer;">å–æ¶ˆ</button>
            <button id="pub-submit" style="padding: 10px 20px; background: linear-gradient(135deg, #10b981, #059669); border: none; border-radius: 8px; color: #fff; font-size: 14px; font-weight: 600; cursor: pointer;">ç¡®è®¤å‘å¸ƒ</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);

      // ç»‘å®šäº‹ä»¶
      document.getElementById('pub-cancel').onclick = () => modal.remove();
      modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

      document.getElementById('pub-submit').onclick = async () => {
        const title = document.getElementById('pub-title').value.trim();
        const category = document.getElementById('pub-category').value;
        const summary = document.getElementById('pub-summary').value.trim();
        const customCreator = document.getElementById('pub-creator').value.trim();

        if (!title) {
          alert('è¯·è¾“å…¥æ ‡é¢˜');
          return;
        }

        // æ„å»ºå®Œæ•´å†…å®¹
        const fullContent = `# ${title}\n\n` +
          `**åˆ†ç±»**: ${category}\n` +
          `**å‘å¸ƒæ—¶é—´**: ${new Date().toLocaleString('zh-CN')}\n\n` +
          `## æ–¹æ¡ˆç®€ä»‹\n${summary || 'æš‚æ— ç®€ä»‹'}\n\n` +
          `---\n\n` +
          `## è¯¦ç»†å†…å®¹\n\n` +
          (result.planningResult ? `### é¦–è¾…ï¼ˆè°‹å±€ï¼‰åˆ†æ\n${result.planningResult}\n\n` : '') +
          (result.executionResult ? `### æ‰§è¡Œè€…æ–¹æ¡ˆ\n${result.executionResult}\n\n` : '') +
          (result.reviewResult ? `### å¾¡å²ï¼ˆå®¡æŸ¥ï¼‰å®¡æ ¸\n${result.reviewResult}\n\n` : '') +
          (result.finalResult ? `### å²å®˜ï¼ˆæ²‰æ·€ï¼‰æ€»ç»“\n${result.finalResult}\n\n` : '') +
          (result.template ? `### ä¸‡èƒ½æ¨¡æ¿\n${result.template}\n\n` : '');

        try {
          const response = await fetch('/api/knowledge/publish', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              title,
              category,
              summary,
              content: fullContent,
              creator: customCreator || undefined
            })
          });

          if (response.ok) {
            const data = await response.json();
            const finalCategory = data.data?.category || category;
            const creator = data.data?.creator || 'å¼€åˆ›è€…';
            const autoCategorized = data.data?.autoCategorized;

            // æ˜¾ç¤ºæˆåŠŸå¼¹çª—
            modal.innerHTML = `
              <div style="background: #1a1a3e; border-radius: 16px; padding: 32px; max-width: 420px; width: 100%; border: 1px solid rgba(16,185,129,0.3); text-align: center;">
                <div style="font-size: 56px; margin-bottom: 16px;">âœ…</div>
                <h3 style="color: #fff; font-size: 20px; margin-bottom: 12px;">æ­å–œæˆä¸ºå¼€åˆ›è€…ï¼</h3>
                <p style="color: #94a3b8; font-size: 13px; margin-bottom: 20px;">ä½ çš„æ–¹æ¡ˆå·²è¿›å…¥çŸ¥è¯†åº“ï¼Œ<span style="color: #f59e0b;">å¼€åˆ›è€…èº«ä»½å·²æ¿€æ´»</span></p>

                <div style="background: rgba(255,255,255,0.05); border-radius: 12px; padding: 16px; margin-bottom: 24px; text-align: left;">
                  <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                    <span style="color: #94a3b8; font-size: 13px;">ğŸ·ï¸ è‡ªåŠ¨åˆ†ç±»</span>
                    <span style="color: #10b981; font-size: 13px; font-weight: 600;">${finalCategory} ${autoCategorized ? '(æ™ºèƒ½è¯†åˆ«)' : ''}</span>
                  </div>
                  <div style="display: flex; justify-content: space-between;">
                    <span style="color: #94a3b8; font-size: 13px;">ğŸ‘¤ å¼€åˆ›è€…èº«ä»½</span>
                    <span style="color: #f59e0b; font-size: 13px; font-weight: 600;">${creator}</span>
                  </div>
                </div>

                <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                  <button id="pub-close-download" style="padding: 12px 24px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #94a3b8; font-size: 14px; font-weight: 600; cursor: pointer;">å…³é—­å¹¶ä¸‹è½½æˆæœ</button>
                  <button id="pub-view-kb" style="padding: 12px 24px; background: linear-gradient(135deg, #667eea, #764ba2); border: none; border-radius: 8px; color: #fff; font-size: 14px; font-weight: 600; cursor: pointer;">ğŸ“š æŸ¥çœ‹çŸ¥è¯†åº“</button>
                  <button id="pub-next-task" style="padding: 12px 24px; background: linear-gradient(135deg, #10b981, #059669); border: none; border-radius: 8px; color: #fff; font-size: 14px; font-weight: 600; cursor: pointer;">å¼€å¯ä¸‹ä¸€æ¬¡ç³»ç»ŸåŒ–</button>
                </div>
              </div>
            `;

            // ç»‘å®šæŒ‰é’®äº‹ä»¶
            document.getElementById('pub-close-download').onclick = () => {
              modal.remove();
              resultSection.scrollIntoView({ behavior: 'smooth' });
            };

            document.getElementById('pub-view-kb').onclick = () => {
              window.open('/knowledge.html', '_blank');
            };

            document.getElementById('pub-next-task').onclick = () => {
              modal.remove();
              window.scrollTo({ top: 0, behavior: 'smooth' });
              userInput.value = '';
              resultSection.style.display = 'none';
              resultContainer.innerHTML = '';
            };
          } else {
            alert('âŒ å‘å¸ƒå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
          }
        } catch (error) {
          console.error('å‘å¸ƒå¤±è´¥:', error);
          alert('âŒ å‘å¸ƒå¤±è´¥: ' + error.message);
        }
      };
    };

    // å°† Markdown æ¸²æŸ“ä¸ºç¾è§‚çš„ HTML
    function renderMarkdown(text) {
      if (!text || typeof text !== 'string') return '';

      try {
        let html = '';
        const lines = text.split('\n');
        let inList = false;
        let listItems = [];

        const flushList = () => {
          if (listItems.length > 0) {
            html += '<div style="margin: 12px 0;">' + listItems.join('') + '</div>';
            listItems = [];
            inList = false;
          }
        };

        const escapeHtml = (str) => {
          if (!str || typeof str !== 'string') return '';
          // ä½¿ç”¨ split/join ä»£æ›¿æ­£åˆ™ï¼Œé¿å… iOS Safari é—®é¢˜
          return str
            .split('&').join('&amp;')
            .split('<').join('&lt;')
            .split('>').join('&gt;');
        };

        const processInline = (str, lineNum) => {
          try {
            if (!str || typeof str !== 'string') return '';
            // å…ˆè½¬ä¹‰ HTML
            let result = escapeHtml(str);
            // ç²—ä½“ - ä½¿ç”¨å­—ç¬¦ä¸²å¤„ç†ä»£æ›¿æ­£åˆ™ï¼Œé¿å…iOS Safarié—®é¢˜
            while (result.includes('**')) {
              const start = result.indexOf('**');
              const end = result.indexOf('**', start + 2);
              if (end === -1) break;
              const boldText = result.substring(start + 2, end);
              result = result.substring(0, start) +
                       '<strong style="color: #fbbf24; font-weight: 600;">' + boldText + '</strong>' +
                       result.substring(end + 2);
            }
            // æ–œä½“ - ä½¿ç”¨ç®€å•å­—ç¬¦ä¸²æ›¿æ¢ï¼Œé¿å…æ­£åˆ™é—®é¢˜
            let parts = result.split('*');
            if (parts.length >= 3) {
              let newResult = parts[0];
              for (let i = 1; i < parts.length; i += 2) {
                if (i + 1 < parts.length) {
                  newResult += '<em style="color: #a78bfa;">' + parts[i] + '</em>' + parts[i+1];
                } else {
                  newResult += '*' + parts[i];
                }
              }
              result = newResult;
            }
            return result;
          } catch (e) {
            console.error('processInlineé”™è¯¯åœ¨è¡Œ' + lineNum + ':', e, 'è¾“å…¥:', str);
            // ä¸å†å¼¹å‡ºalertï¼Œé¿å…å½±å“ç”¨æˆ·ä½“éªŒ
            return escapeHtml(str);
          }
        };

        for (let i = 0; i < lines.length; i++) {
          try {
            const line = lines[i];
            const trimmed = line.trim();

            // ç©ºè¡Œ
            if (!trimmed) {
              flushList();
              html += '<br>';
              continue;
            }

            // åˆ†å‰²çº¿
            if (trimmed === '---' || trimmed === '***' || trimmed === '___') {
              flushList();
              html += '<hr style="border: none; border-top: 1px solid rgba(255,255,255,0.1); margin: 20px 0;">';
              continue;
            }

            // æ ‡é¢˜
            if (trimmed.startsWith('# ')) {
              flushList();
              const content = processInline(trimmed.slice(2), i);
              html += '<h1 style="color: #667eea; font-size: 22px; margin: 28px 0 16px; font-weight: 700; border-bottom: 2px solid #667eea; padding-bottom: 8px;">' + content + '</h1>';
              continue;
            }
            if (trimmed.startsWith('## ')) {
              flushList();
              const content = processInline(trimmed.slice(3), i);
              html += '<h2 style="color: #f093fb; font-size: 19px; margin: 24px 0 14px; font-weight: 600;">' + content + '</h2>';
              continue;
            }
            if (trimmed.startsWith('### ')) {
              flushList();
              const content = processInline(trimmed.slice(4), i);
              html += '<h3 style="color: #667eea; font-size: 17px; margin: 20px 0 12px; font-weight: 600; border-bottom: 1px solid rgba(102,126,234,0.3); padding-bottom: 8px;">' + content + '</h3>';
              continue;
            }
            if (trimmed.startsWith('#### ')) {
              flushList();
              const content = processInline(trimmed.slice(5), i);
              html += '<h4 style="color: #e2e8f0; font-size: 15px; margin: 18px 0 10px; font-weight: 600;">' + content + '</h4>';
              continue;
            }
            if (trimmed.startsWith('##### ')) {
              flushList();
              const content = processInline(trimmed.slice(6), i);
              html += '<h5 style="color: #94a3b8; font-size: 14px; margin: 16px 0 8px; font-weight: 600;">' + content + '</h5>';
              continue;
            }

            // æ— åºåˆ—è¡¨ - iOS Safari 16å…¼å®¹ä¿®å¤
            if (trimmed.charAt(0) === '-' && trimmed.charAt(1) === ' ') {
              const content = processInline(trimmed.slice(2), i);
              listItems.push('<div style="margin: 4px 0; padding-left: 16px; position: relative;"><span style="position: absolute; left: 0; color: #667eea; font-weight: bold;">â€¢</span>' + content + '</div>');
              inList = true;
              continue;
            }
            if (trimmed.charAt(0) === '*' && trimmed.charAt(1) === ' ') {
              const content = processInline(trimmed.slice(2), i);
              listItems.push('<div style="margin: 4px 0; padding-left: 16px; position: relative;"><span style="position: absolute; left: 0; color: #667eea; font-weight: bold;">â€¢</span>' + content + '</div>');
              inList = true;
              continue;
            }

            // æœ‰åºåˆ—è¡¨ - iOS Safari 16å…¼å®¹ä¿®å¤
            let dotPos = -1;
            for (let j = 0; j < trimmed.length; j++) {
              if (trimmed.charAt(j) === '.' && trimmed.charAt(j + 1) === ' ') {
                dotPos = j;
                break;
              }
            }
            if (dotPos > 0) {
              let isAllDigits = true;
              for (let j = 0; j < dotPos; j++) {
                const c = trimmed.charAt(j);
                if (c < '0' || c > '9') {
                  isAllDigits = false;
                  break;
                }
              }
              if (isAllDigits) {
                const numPart = trimmed.substring(0, dotPos);
                const content = processInline(trimmed.substring(dotPos + 2), i);
                listItems.push('<div style="margin: 4px 0; padding-left: 24px; position: relative;"><span style="position: absolute; left: 0; color: #10b981; font-weight: 600;">' + numPart + '.</span>' + content + '</div>');
                inList = true;
                continue;
              }
            }

            // æ™®é€šæ®µè½
            flushList();
            const content = processInline(trimmed, i);
            html += '<p style="margin: 8px 0; line-height: 1.8;">' + content + '</p>';
          } catch (lineError) {
            console.error('å¤„ç†ç¬¬' + i + 'è¡Œæ—¶å‡ºé”™:', lineError, 'å†…å®¹:', lines[i]);
            alert('æ¸²æŸ“ç¬¬' + i + 'è¡Œæ—¶å‡ºé”™: ' + lineError.message + '\nå†…å®¹: ' + lines[i].substring(0, 50));
            continue;
          }
        }

        flushList();

        // æ¸…ç†å¤šä½™çš„ <br> - ä½¿ç”¨å­—ç¬¦ä¸²å¤„ç†ä»£æ›¿æ­£åˆ™
        while (html.includes('<br><br><br>')) {
          html = html.split('<br><br><br>').join('<br><br>');
        }
        // æ¸…ç†ç©ºæ®µè½ - ä½¿ç”¨å­—ç¬¦ä¸²å¤„ç†ä»£æ›¿æ­£åˆ™
        html = html.split('<p style="margin: 8px 0; line-height: 1.8;"></p>').join('');

        return html;
      } catch (error) {
        console.error('renderMarkdown æ•´ä½“é”™è¯¯:', error);
        alert('Markdownæ¸²æŸ“é”™è¯¯: ' + error.message + '\n\nå°†æ˜¾ç¤ºçº¯æ–‡æœ¬');
        // å¤±è´¥æ—¶è¿”å›ç®€å•è½¬ä¹‰æ–‡æœ¬
        return text
          .split('&').join('&amp;')
          .split('<').join('&lt;')
          .split('>').join('&gt;')
          .split('\n').join('<br>');
      }
    }

    // æ˜¾ç¤ºå¤±è´¥è¯¦æƒ…
    function displayFailure(statusData) {
      resultSection.style.display = 'block';
      resultContainer.innerHTML = '';

      // å¤±è´¥æ ‡é¢˜
      const failHeader = document.createElement('div');
      failHeader.className = 'result-card';
      failHeader.style.borderLeft = '4px solid #ef4444';

      const failStep = getStepName(statusData.failStep) || 'å®¡æŸ¥ç¯èŠ‚';
      const failReason = statusData.failReason || 'å®¡æ ¸æœªé€šè¿‡ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°';
      const retryCount = statusData.retryCount || 0;

      failHeader.innerHTML = `
        <div class="result-header">
          <div class="result-icon" style="background: linear-gradient(135deg, #ef4444, #dc2626);">âŒ</div>
          <div class="result-title">
            <h3>ä»»åŠ¡æ‰§è¡Œå¤±è´¥</h3>
            <p>å›¢é˜Ÿåä½œæœªèƒ½å®Œæˆä»»åŠ¡</p>
          </div>
        </div>
      `;

      // åˆ›å»ºå†…å®¹åŒº
      const contentDiv = document.createElement('div');
      contentDiv.className = 'result-content';
      contentDiv.style.marginTop = '16px';

      // å¤±è´¥ç¯èŠ‚
      const failStepDiv = document.createElement('div');
      failStepDiv.style.cssText = 'background: rgba(239, 68, 68, 0.1); border-radius: 12px; padding: 16px; margin-bottom: 16px;';
      failStepDiv.innerHTML = '<h4 style="color: #ef4444; margin-bottom: 8px;">ğŸ“ å¤±è´¥ç¯èŠ‚</h4>';
      const failStepP = document.createElement('p');
      failStepP.style.color = '#e2e8f0';
      failStepP.textContent = failStep;
      failStepDiv.appendChild(failStepP);
      contentDiv.appendChild(failStepDiv);

      // å¤±è´¥åŸå› 
      const failReasonDiv = document.createElement('div');
      failReasonDiv.style.cssText = 'background: rgba(239, 68, 68, 0.05); border-radius: 12px; padding: 16px; margin-bottom: 16px;';
      failReasonDiv.innerHTML = '<h4 style="color: #f87171; margin-bottom: 8px;">â— å¤±è´¥åŸå› </h4>';
      const failReasonP = document.createElement('p');
      failReasonP.style.cssText = 'color: #e2e8f0; line-height: 1.6;';
      failReasonP.textContent = failReason;
      failReasonDiv.appendChild(failReasonP);
      contentDiv.appendChild(failReasonDiv);

      // é‡è¯•æ¬¡æ•°
      if (retryCount > 0) {
        const retryDiv = document.createElement('div');
        retryDiv.style.cssText = 'background: rgba(99, 102, 241, 0.1); border-radius: 12px; padding: 16px; margin-bottom: 16px;';
        retryDiv.innerHTML = '<h4 style="color: #818cf8; margin-bottom: 8px;">ğŸ”„ é‡è¯•æ¬¡æ•°</h4>';
        const retryP = document.createElement('p');
        retryP.style.color = '#e2e8f0';
        retryP.textContent = 'å…±å°è¯• ' + retryCount + ' æ¬¡';
        retryDiv.appendChild(retryP);
        contentDiv.appendChild(retryDiv);
      }

      failHeader.appendChild(contentDiv);
      resultContainer.appendChild(failHeader);

      // æ˜¾ç¤ºå·²æœ‰çš„æˆæœ
      if (statusData.planningResult) {
        addResultCard('é¦–è¾…ï¼ˆè°‹å±€ï¼‰', 'åˆ†æéœ€æ±‚å¹¶åˆ¶å®šè¡ŒåŠ¨æŒ‡å—', statusData.planningResult);
      }

      if (statusData.executionResult) {
        addResultCard('å¹²åï¼ˆæ‰§è¡Œï¼‰', 'æ ¹æ®è¡ŒåŠ¨æŒ‡å—æ‰§è¡Œä»»åŠ¡', statusData.executionResult);
      }

      if (statusData.reviewResult) {
        addResultCard('å¾¡å²ï¼ˆå®¡æŸ¥ï¼‰', 'å®¡æ ¸æ‰§è¡Œæˆæœ', statusData.reviewResult);
      }

      // æ·»åŠ å»ºè®®
      const suggestionCard = document.createElement('div');
      suggestionCard.className = 'result-card';
      suggestionCard.style.borderLeft = '4px solid #10b981';
      suggestionCard.innerHTML = `
        <div class="result-header">
          <div class="result-icon" style="background: linear-gradient(135deg, #10b981, #059669);">ğŸ’¡</div>
          <div class="result-title">
            <h3>æ”¹è¿›å»ºè®®</h3>
            <p>å¦‚ä½•è®©ä»»åŠ¡æ›´å®¹æ˜“é€šè¿‡</p>
          </div>
        </div>
      `;

      const suggestionContent = document.createElement('div');
      suggestionContent.className = 'result-content';
      suggestionContent.style.marginTop = '16px';

      const suggestionList = document.createElement('ul');
      suggestionList.style.cssText = 'color: #e2e8f0; line-height: 1.8; padding-left: 20px;';

      const suggestions = [
        'éœ€æ±‚æè¿°æ›´å…·ä½“ï¼ŒåŒ…å«èƒŒæ™¯ã€ç›®æ ‡ã€çº¦æŸæ¡ä»¶',
        'æä¾›å…·ä½“çš„ä¾‹å­æˆ–å‚è€ƒæ ‡å‡†',
        'è¯´æ˜æœŸæœ›çš„è¾“å‡ºæ ¼å¼å’Œè¯¦ç»†ç¨‹åº¦',
        'å¦‚æœæ¶‰åŠä¸“ä¸šçŸ¥è¯†ï¼Œæä¾›ç›¸å…³æœ¯è¯­è§£é‡Š'
      ];

      suggestions.forEach(text => {
        const li = document.createElement('li');
        li.textContent = text;
        suggestionList.appendChild(li);
      });

      suggestionContent.appendChild(suggestionList);
      suggestionCard.appendChild(suggestionContent);
      resultContainer.appendChild(suggestionCard);

      // å¦‚æœæœ‰éƒ¨åˆ†æˆæœï¼Œæ·»åŠ ä¸‹è½½æŒ‰é’®
      if (statusData.planningResult || statusData.executionResult || statusData.reviewResult) {
        const partialResult = {
          planningResult: statusData.planningResult,
          executionResult: statusData.executionResult,
          reviewResult: statusData.reviewResult
        };
        addDownloadButtons(partialResult);
      }

      // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
      resultSection.scrollIntoView({ behavior: 'smooth' });

      // æ¢å¤æŒ‰é’®çŠ¶æ€
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<span>é‡æ–°æ‰§è¡Œ</span>';
      resetBtn.disabled = false;
    }

    // è·å–ç¯èŠ‚åç§°
    function getStepName(step) {
      const stepNames = {
        'planning': 'è°‹å±€é˜¶æ®µï¼ˆé¦–è¾…ï¼‰',
        'executing': 'æ‰§è¡Œé˜¶æ®µï¼ˆå¹²åï¼‰',
        'reviewing': 'å®¡æŸ¥é˜¶æ®µï¼ˆå¾¡å²ï¼‰',
        'finalizing': 'æ²‰æ·€é˜¶æ®µï¼ˆå²å®˜ï¼‰'
      };
      return stepNames[step] || step;
    }

    // åˆå§‹åŒ–å·¥ä½œæµæ­¥éª¤
    function initializeWorkflowSteps() {
      const steps = ['planning', 'execution', 'review', 'archive'];

      steps.forEach(step => {
        const stepEl = document.getElementById(`step-${step}`);
        if (!stepEl) return;

        const statusEl = stepEl.querySelector('.step-status');
        const thinkingEl = document.getElementById(`${step}-thinking`);
        const outputEl = document.getElementById(`${step}-output`);

        stepEl.classList.remove('active', 'completed', 'failed');
        statusEl.textContent = 'â¸ï¸ ç­‰å¾…ä¸­';

        if (thinkingEl) {
          thinkingEl.textContent = step === 'planning' ? 'æ­£åœ¨åˆ†ææ‚¨çš„éœ€æ±‚...' :
                                   step === 'execution' ? 'ç­‰å¾…å¯åŠ¨...' :
                                   step === 'review' ? 'ç­‰å¾…å®¡æ ¸...' : 'ç­‰å¾…æ€»ç»“...';
        }
        if (outputEl) {
          outputEl.textContent = 'ç­‰å¾…ç”Ÿæˆ...';
        }
      });
    }

    // æ›´æ–°å·¥ä½œæµæ­¥éª¤æ˜¾ç¤º
    function updateWorkflowSteps(statusData) {
      const steps = ['planning', 'execution', 'review', 'archive'];
      // å°†åç«¯çŠ¶æ€æ˜ å°„åˆ°å‰ç«¯æ­¥éª¤åç§°
      let currentStatus = statusData.status;
      const statusMapping = {
        'planning': 'planning',
        'executing': 'execution',
        'reviewing': 'review',
        'finalizing': 'archive',
        'completed': 'completed',
        'failed': 'failed'
      };
      currentStatus = statusMapping[currentStatus] || currentStatus;

      steps.forEach((step, index) => {
        const stepEl = document.getElementById(`step-${step}`);
        if (!stepEl) return;

        const statusEl = stepEl.querySelector('.step-status');
        const thinkingEl = document.getElementById(`${step}-thinking`);
        const outputEl = document.getElementById(`${step}-output`);

        // è·å–å½“å‰çŠ¶æ€åœ¨stepsä¸­çš„ç´¢å¼•
        const currentIndex = steps.indexOf(currentStatus);
        const stepIndex = steps.indexOf(step);

        // æ ¹æ®å½“å‰çŠ¶æ€æ›´æ–°æ­¥éª¤
        if (currentStatus === step) {
          // å½“å‰æ­£åœ¨æ‰§è¡Œçš„æ­¥éª¤
          stepEl.classList.add('active');
          stepEl.classList.remove('completed', 'failed');
          statusEl.textContent = 'â³ è¿›è¡Œä¸­';

          // å¦‚æœæœ‰ä¸­é—´ç»“æœï¼Œæ˜¾ç¤ºå‡ºæ¥
          if (statusData[`${step}_thinking`] && thinkingEl) {
            thinkingEl.textContent = statusData[`${step}_thinking`];
          }
          if (statusData[`${step}_output`] && outputEl) {
            outputEl.textContent = statusData[`${step}_output`];
          }
        } else if (currentIndex > stepIndex || statusData.status === 'completed') {
          // å·²å®Œæˆçš„æ­¥éª¤ï¼ˆåŒ…æ‹¬completedçŠ¶æ€æ—¶æ‰€æœ‰æ­¥éª¤éƒ½å·²å®Œæˆï¼‰
          stepEl.classList.remove('active');
          stepEl.classList.add('completed');
          statusEl.textContent = 'âœ… å·²å®Œæˆ';

          // æ˜¾ç¤ºæœ€ç»ˆç»“æœ
          if (statusData[`${step}_thinking`] && thinkingEl) {
            thinkingEl.textContent = statusData[`${step}_thinking`];
          }
          if (statusData[`${step}_output`] && outputEl) {
            outputEl.textContent = statusData[`${step}_output`];
          }
        } else {
          // ç­‰å¾…ä¸­çš„æ­¥éª¤
          stepEl.classList.remove('active', 'completed', 'failed');
          statusEl.textContent = 'â¸ï¸ ç­‰å¾…ä¸­';
        }
      });

      // å¦‚æœå¤±è´¥ï¼Œæ ‡è®°å½“å‰æ­¥éª¤ä¸ºå¤±è´¥
      if (currentStatus === 'failed') {
        const activeStep = document.querySelector('.workflow-step.active');
        if (activeStep) {
          activeStep.classList.remove('active');
          activeStep.classList.add('failed');
          activeStep.querySelector('.step-status').textContent = 'âŒ å¤±è´¥';
        }
      }
    }

    function addResultCard(title, subtitle, content, type = '') {
      const card = document.createElement('div');
      card.className = 'result-card';

      // æ ¹æ®ç±»å‹è®¾ç½®è¾¹æ¡†é¢œè‰²
      const colors = {
        'planning': '#667eea',
        'execution': '#f093fb',
        'review': '#4facfe',
        'final': '#f5576c',
        'template': '#10b981'
      };
      const borderColor = colors[type] || '#667eea';
      card.style.borderLeft = `4px solid ${borderColor}`;

      // è®¡ç®—å­—æ•°
      const charCount = content?.length || 0;
      const wordCount = charCount > 1000 ? (charCount/1000).toFixed(1) + 'k' : charCount;

      // ä¼°ç®—é˜…è¯»æ—¶é—´ï¼ˆæŒ‰ 300å­—/åˆ†é’Ÿï¼‰
      const readTime = Math.max(1, Math.ceil(charCount / 300));

      card.innerHTML = `
        <div class="result-header">
          <div class="result-icon" style="background: linear-gradient(135deg, ${borderColor}, ${borderColor}aa);">${title.charAt(0)}</div>
          <div class="result-title" style="flex: 1;">
            <h3 style="margin-bottom: 4px;">${title}</h3>
            <p style="color: #94a3b8; font-size: 13px;">${subtitle}</p>
          </div>
          <div style="text-align: right;">
            <div style="font-size: 18px; font-weight: 700; color: ${borderColor};">${wordCount}</div>            <div style="font-size: 11px; color: #64748b;">å­— Â· ${readTime}åˆ†é’Ÿé˜…è¯»</div>
          </div>        </div>
        <div class="result-content" style="margin-top: 16px; line-height: 1.8; color: #e2e8f0;">${renderMarkdown(content)}</div>
        <div style="margin-top: 12px; text-align: right;" class="copy-btn-container"></div>
      `;

      // åˆ›å»ºå¤åˆ¶æŒ‰é’®ï¼ˆä½¿ç”¨DOM APIé¿å…HTMLå±æ€§æ³¨å…¥é—®é¢˜ï¼‰
      const copyBtnContainer = card.querySelector('.copy-btn-container');

      // åˆ›å»ºæŒ‰é’®å®¹å™¨ - ä½¿ç”¨flexå¸ƒå±€ç¡®ä¿å¯¹é½
      const btnContainer = document.createElement('div');
      btnContainer.style.cssText = 'display: flex; gap: 8px; justify-content: flex-end; align-items: center;';

      // æŒ‰é’®åŸºç¡€æ ·å¼
      const baseBtnStyle = 'padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; transition: all 0.3s; display: inline-flex; align-items: center; gap: 4px; line-height: 1.5;';

      // ç»§ç»­ä¼˜åŒ–æŒ‰é’®
      const optimizeBtn = document.createElement('button');
      optimizeBtn.style.cssText = baseBtnStyle + ' background: linear-gradient(135deg, #667eea, #764ba2); border: none; color: #fff;';
      optimizeBtn.innerHTML = 'ğŸ”„ ç»§ç»­ä¼˜åŒ–';
      optimizeBtn.onclick = function() {
        // å›åˆ°é¡¶éƒ¨
        window.scrollTo({ top: 0, behavior: 'smooth' });

        // é¢„å¡«å……è¾“å…¥æ¡†
        const context = `ã€åŸºäºä¹‹å‰çš„æ–¹æ¡ˆç»§ç»­ä¼˜åŒ–ã€‘\n\nä¹‹å‰${title}çš„æ ¸å¿ƒå†…å®¹ï¼š\n${content.substring(0, 500)}${content.length > 500 ? '...' : ''}\n\næˆ‘éœ€è¦è¿›ä¸€æ­¥ä¼˜åŒ–ï¼š\n`;
        userInput.value = context;
        userInput.focus();

        // å¯é€‰ï¼šæ¸…ç©ºä¹‹å‰çš„ç»“æœåŒºåŸŸ
        resultSection.style.display = 'none';
        resultContainer.innerHTML = '';

        // æ˜¾ç¤ºæç¤º
        statusText.textContent = 'å·²åŠ è½½ä¸Šä¸‹æ–‡ï¼Œè¯·è¡¥å……ä¼˜åŒ–éœ€æ±‚åç‚¹å‡»å¼€å§‹æ‰§è¡Œ';
        statusText.style.color = '#10b981';
      };

      // å¤åˆ¶æŒ‰é’®
      const copyBtn = document.createElement('button');
      copyBtn.style.cssText = baseBtnStyle + ' background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #94a3b8;';
      copyBtn.innerHTML = 'ğŸ“‹ å¤åˆ¶å†…å®¹';
      copyBtn.onclick = function() {
        copyToClipboard(this, content || '');
      };

      btnContainer.appendChild(optimizeBtn);
      btnContainer.appendChild(copyBtn);
      copyBtnContainer.appendChild(btnContainer);

      resultContainer.appendChild(card);
    }

    // å®æ—¶æ˜¾ç¤ºå„è§’è‰²è¾“å‡º
    function displayRealtimeOutput(statusData) {
      // ç¡®ä¿ç»“æœåŒºåŸŸå¯è§
      if (resultSection.style.display === 'none') {
        resultSection.style.display = 'block';
      }

      // æ¸…ç©ºä¹‹å‰çš„å†…å®¹é‡æ–°æ¸²æŸ“ï¼ˆä¿æŒæœ€æ–°ï¼‰
      resultContainer.innerHTML = '';

      // åˆ›å»ºå¡ç‰‡è¾…åŠ©å‡½æ•°
      function createRoleCard(title, icon, color, content, status, statusText) {
        const card = document.createElement('div');
        card.className = 'result-card';
        card.style.borderLeft = '4px solid ' + color;
        card.innerHTML = `
          <div class="result-header">
            <div class="result-icon" style="background: linear-gradient(135deg, ${color}, ${color}aa);">${icon}</div>
            <div class="result-title">
              <h3>${title}</h3>
              <p>${statusText}</p>
            </div>
          </div>
          <div class="result-content" style="margin-top: 12px; max-height: 300px; overflow-y: auto;">
            ${renderMarkdown(content)}
          </div>
          <div style="margin-top: 12px; text-align: right;" class="copy-btn-container"></div>
        `;

        // åˆ›å»ºå¤åˆ¶æŒ‰é’®
        const copyBtnContainer = card.querySelector('.copy-btn-container');
        const copyBtn = document.createElement('button');
        copyBtn.style.cssText = 'padding: 6px 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: #94a3b8; font-size: 12px; cursor: pointer; transition: all 0.3s; display: inline-flex; align-items: center; gap: 4px;';
        copyBtn.innerHTML = 'ğŸ“‹ å¤åˆ¶å†…å®¹';
        copyBtn.onclick = function() {
          copyToClipboard(this, content || '');
        };
        copyBtnContainer.appendChild(copyBtn);

        return card;
      }

      // æ˜¾ç¤ºè°‹å±€è€…è¾“å‡º
      if (statusData.planningResult) {
        const isCompleted = statusData.status === 'executing' || statusData.status === 'reviewing' || statusData.status === 'finalizing' || statusData.status === 'completed';
        const planningCard = createRoleCard(
          'é¦–è¾…ï¼ˆè°‹å±€ï¼‰',
          'è°‹',
          '#667eea',
          statusData.planningResult,
          statusData.status,
          statusData.status === 'planning' ? 'æ­£åœ¨åˆ†æ...' : (isCompleted ? 'åˆ†æå®Œæˆ' : 'ç­‰å¾…ä¸­')
        );
        resultContainer.appendChild(planningCard);
      }

      // æ˜¾ç¤ºæ‰§è¡Œè€…è¾“å‡º
      if (statusData.executionResult) {
        const isCompleted = statusData.status === 'reviewing' || statusData.status === 'finalizing' || statusData.status === 'completed';
        const executionCard = createRoleCard(
          'å¹²åï¼ˆæ‰§è¡Œï¼‰',
          'æ‰§',
          '#f093fb',
          statusData.executionResult,
          statusData.status,
          statusData.status === 'executing' ? 'æ­£åœ¨å¹²æ´»...' : (isCompleted ? 'æ‰§è¡Œå®Œæˆ' : 'ç­‰å¾…ä¸­')
        );
        resultContainer.appendChild(executionCard);
      }

      // æ˜¾ç¤ºå®¡æŸ¥å‘˜è¾“å‡º
      if (statusData.reviewResult) {
        const isCompleted = statusData.status === 'finalizing' || statusData.status === 'completed';
        const reviewCard = createRoleCard(
          'å¾¡å²ï¼ˆå®¡æŸ¥ï¼‰',
          'æŸ¥',
          '#4facfe',
          statusData.reviewResult,
          statusData.status,
          statusData.status === 'reviewing' ? 'æ­£åœ¨å®¡æ ¸...' : (isCompleted ? 'å®¡æ ¸å®Œæˆ' : 'ç­‰å¾…ä¸­')
        );

        // æ·»åŠ é‡è¯•æ¬¡æ•°æ˜¾ç¤º
        if (statusData.retryCount) {
          const retryDiv = document.createElement('div');
          retryDiv.style.cssText = 'margin-top: 12px; padding: 8px 12px; background: rgba(99, 102, 241, 0.1); border-radius: 8px; font-size: 12px; color: #818cf8;';
          retryDiv.textContent = 'ç¬¬ ' + statusData.retryCount + ' è½®å®¡æŸ¥';
          reviewCard.appendChild(retryDiv);
        }

        resultContainer.appendChild(reviewCard);
      }

      // æ˜¾ç¤ºæ²‰æ·€è€…è¾“å‡º
      if (statusData.finalResult || statusData.template) {
        const finalCard = createRoleCard(
          'å²å®˜ï¼ˆæ²‰æ·€ï¼‰',
          'è®°',
          '#10b981',
          statusData.finalResult || statusData.template || 'æ­£åœ¨æ€»ç»“...',
          statusData.status,
          (statusData.status === 'finalizing' || statusData.status === 'completed') ? 'æ­£åœ¨æ€»ç»“...' : 'æ€»ç»“å®Œæˆ'
        );
        resultContainer.appendChild(finalCard);
      }

      // æ»šåŠ¨åˆ°æœ€æ–°å†…å®¹
      resultContainer.scrollTop = resultContainer.scrollHeight;
    }
  </script>
</body>
</html>
