# OpenCloudOS 9.4 + 2GB内存 AI长连接服务器调优配置
# 适用于：Diyici.ai 多智能体协作平台
# 配置日期：2026-02-21

# ==========================================
# 核心内存管理参数
# ==========================================

# vm.swappiness: 控制Swap使用倾向
# 默认值30，对于2GB小内存+SSD，建议设为10-20
# 值越低，越倾向于使用物理内存，减少Swap抖动
vm.swappiness = 15

# vm.vfs_cache_pressure: 控制内核回收目录和inode缓存的倾向
# 默认值100，设为50让内核更保守地回收缓存，减少IO
vm.vfs_cache_pressure = 50

# vm.dirty_ratio / dirty_background_ratio: 控制脏页刷新
# 避免大量脏页同时刷新导致IO阻塞
vm.dirty_ratio = 15
vm.dirty_background_ratio = 5

# vm.dirty_expire_centisecs: 脏页过期时间（百分之一秒）
# 3000 = 30秒，让脏页更快写入磁盘，减少内存压力
vm.dirty_expire_centisecs = 3000

# vm.dirty_writeback_centisecs: 脏页回写间隔
# 500 = 5秒，更频繁地小批量写入，避免突发IO
vm.dirty_writeback_centisecs = 500

# ==========================================
# 网络优化（长连接场景）
# ==========================================

# 增大TCP连接跟踪表（高并发长连接）
net.netfilter.nf_conntrack_max = 65536

# TCP Keepalive 参数优化
# 对于AI长连接，需要更宽容的保活检测
net.ipv4.tcp_keepalive_time = 300
net.ipv4.tcp_keepalive_intvl = 30
net.ipv4.tcp_keepalive_probes = 5

# TCP 内存自动调节
net.ipv4.tcp_moderate_rcvbuf = 1

# 增大本地端口范围（高并发）
net.ipv4.ip_local_port_range = 1024 65535

# ==========================================
# 文件描述符限制
# ==========================================

# 增大系统级文件描述符限制
fs.file-max = 2097152

# ==========================================
# 虚拟内存区域限制（防止Node.js/V8 OOM）
# ==========================================

# 增大vm.max_map_count，防止Node.js大型应用崩溃
vm.max_map_count = 262144
